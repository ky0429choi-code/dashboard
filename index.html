<!doctype html>
<html lang="ko">

<head>
    <meta charset="utf-8" />
    <meta name="viewport"
        content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
    <meta name="theme-color" content="#0a0f1e" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Samsung Welstory Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0a0f1e;
            --surface: #111827;
            --card: rgba(17, 24, 39, .85);
            --card-hover: rgba(23, 32, 52, .9);
            --border: rgba(148, 163, 184, .08);
            --border-hover: rgba(56, 189, 248, .2);
            --accent: #38bdf8;
            --accent2: #818cf8;
            --accent3: #a78bfa;
            --success: #34d399;
            --warning: #fbbf24;
            --danger: #f87171;
            --text: #f1f5f9;
            --muted: #64748b;
            --dim: #475569;
            --r: 16px;
            --r2: 12px;
            --shadow: 0 8px 32px rgba(0, 0, 0, .4);
            --glow: 0 0 20px rgba(56, 189, 248, .08);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-font-smoothing: antialiased
        }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'Inter', 'Malgun Gothic', sans-serif;
            min-height: 100vh;
            min-height: 100dvh;
            overflow-x: hidden
        }

        input,
        textarea,
        select,
        button {
            font-family: inherit;
            user-select: auto !important;
            -webkit-user-select: auto !important
        }

        /* ===== LOGIN ===== */
        .login-overlay {
            position: fixed;
            inset: 0;
            background: var(--bg);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000
        }

        .login-bg {
            position: absolute;
            inset: 0;
            background: radial-gradient(ellipse at 50% 30%, rgba(56, 189, 248, .06), transparent 60%), radial-gradient(ellipse at 80% 80%, rgba(129, 140, 248, .04), transparent 50%)
        }

        .login-card {
            position: relative;
            background: linear-gradient(145deg, rgba(17, 24, 39, .9), rgba(15, 23, 42, .95));
            padding: 48px 32px 36px;
            border-radius: 28px;
            border: 1px solid rgba(148, 163, 184, .06);
            width: 88%;
            max-width: 380px;
            text-align: center;
            box-shadow: 0 24px 64px rgba(0, 0, 0, .5), var(--glow)
        }

        .login-logo {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            border-radius: 14px;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            box-shadow: 0 8px 24px rgba(56, 189, 248, .2)
        }

        .login-card h2 {
            font-size: 22px;
            font-weight: 900;
            letter-spacing: -.5px;
            margin-bottom: 6px;
            background: linear-gradient(90deg, #fff, var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent
        }

        .login-card p {
            color: var(--muted);
            font-size: 13px;
            margin-bottom: 28px;
            line-height: 1.5
        }

        .login-field {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, .03);
            border: 1.5px solid rgba(148, 163, 184, .1);
            border-radius: 14px;
            margin-bottom: 10px;
            height: 50px;
            padding: 0 16px;
            transition: all .3s
        }

        .login-field:focus-within {
            border-color: var(--accent);
            background: rgba(56, 189, 248, .04);
            box-shadow: 0 0 0 3px rgba(56, 189, 248, .08)
        }

        .login-field input {
            flex: 1;
            min-width: 0;
            height: 100%;
            background: none;
            border: none;
            color: #fff;
            font-size: 14px;
            font-weight: 700;
            outline: none
        }

        .login-field input::placeholder {
            color: var(--dim);
            font-weight: 600
        }

        .domain-tag {
            color: var(--accent);
            font-size: 11px;
            font-weight: 800;
            opacity: .7;
            flex-shrink: 0;
            white-space: nowrap
        }

        #loginPw {
            width: 100%;
            height: 50px;
            padding: 0 16px;
            background: rgba(255, 255, 255, .03);
            border: 1.5px solid rgba(148, 163, 184, .1);
            border-radius: 14px;
            color: #fff;
            margin-bottom: 20px;
            font-size: 14px;
            font-weight: 700;
            outline: none;
            transition: all .3s
        }

        #loginPw:focus {
            border-color: var(--accent);
            background: rgba(56, 189, 248, .04);
            box-shadow: 0 0 0 3px rgba(56, 189, 248, .08)
        }

        #loginPw::placeholder {
            color: var(--dim);
            font-weight: 600
        }

        .login-btn {
            width: 100%;
            height: 50px;
            border-radius: 14px;
            border: none;
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            color: #fff;
            font-weight: 900;
            font-size: 15px;
            cursor: pointer;
            letter-spacing: -.3px;
            box-shadow: 0 4px 16px rgba(56, 189, 248, .25);
            transition: all .2s
        }

        .login-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 24px rgba(56, 189, 248, .35)
        }

        .login-btn:disabled {
            opacity: .4;
            transform: none;
            cursor: not-allowed
        }

        #login-error {
            color: var(--danger);
            font-size: 12px;
            margin-top: 14px;
            font-weight: 700;
            display: none;
            line-height: 1.5;
            background: rgba(248, 113, 113, .06);
            padding: 10px 14px;
            border-radius: 10px;
            border: 1px solid rgba(248, 113, 113, .1);
            width: 100%;
            text-align: left
        }

        /* ===== SPLASH ===== */
        #splash {
            position: fixed;
            inset: 0;
            background: var(--bg);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000
        }

        .sp-ring {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, .06);
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            animation: spin .7s linear infinite
        }

        @keyframes spin {
            to {
                transform: rotate(360deg)
            }
        }

        /* ===== DASHBOARD ===== */
        #dashboard {
            display: none;
            opacity: 0;
            flex-direction: column;
            width: 100%;
            overflow-y: auto;
            transition: opacity .4s
        }

        header {
            position: sticky;
            top: 0;
            z-index: 200;
            background: rgba(10, 15, 30, .92);
            border-bottom: 1px solid var(--border);
            backdrop-filter: blur(20px) saturate(1.2);
            padding: env(safe-area-inset-top, 12px) 20px 14px
        }

        .header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
            gap: 8px;
            min-width: 0
        }

        .header-top>div:first-child {
            min-width: 0;
            flex: 1 1 0;
            overflow: hidden
        }

        .header-top h1 {
            font-size: clamp(12px, 3.8vw, 18px);
            font-weight: 900;
            letter-spacing: -.5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            background: linear-gradient(90deg, var(--accent), var(--accent2));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent
        }

        #lastUpdate {
            font-size: 10px;
            color: var(--dim);
            font-weight: 700;
            margin-top: 3px
        }

        /* Í∂åÌïú Î∞∞ÏßÄ */
        #role-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 800;
            margin-top: 4px;
            border: 1px solid
        }

        .hdr-btns {
            display: flex;
            gap: 6px
        }

        .hdr-btn {
            height: 34px;
            padding: 0 12px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: rgba(255, 255, 255, .03);
            color: var(--text);
            font-size: 12px;
            font-weight: 800;
            cursor: pointer;
            transition: all .2s;
            display: flex;
            align-items: center;
            gap: 4px
        }

        .hdr-btn:hover {
            border-color: var(--accent);
            background: rgba(56, 189, 248, .06)
        }

        .hdr-btn.accent {
            border-color: rgba(56, 189, 248, .2);
            color: var(--accent)
        }

        .filter-row {
            display: flex;
            gap: 6px;
            overflow-x: auto;
            scrollbar-width: none;
            padding-bottom: 2px
        }

        .filter-row::-webkit-scrollbar {
            display: none
        }

        .chip {
            padding: 7px 14px;
            border-radius: 999px;
            border: 1.5px solid rgba(148, 163, 184, .1);
            background: rgba(255, 255, 255, .02);
            color: var(--dim);
            font-weight: 800;
            font-size: 12px;
            white-space: nowrap;
            cursor: pointer;
            transition: all .25s
        }

        .chip:hover {
            border-color: rgba(56, 189, 248, .3);
            color: var(--text)
        }

        .chip.active {
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            color: #fff;
            border-color: transparent;
            box-shadow: 0 2px 12px rgba(56, 189, 248, .2)
        }

        main {
            padding: 16px;
            display: grid;
            gap: 14px;
            max-width: 580px;
            margin: 0 auto;
            width: 100%
        }

        /* ===== CARD ===== */
        .card {
            background: var(--card);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border);
            border-radius: var(--r);
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: border-color .3s
        }

        .card:hover {
            border-color: var(--border-hover)
        }

        /* ‚ñº Ïπ¥Îìú ÎÇ¥Î∂Ä paddingÏùÄ card-innerÎ°ú Î∂ÑÎ¶¨ (Î∞∞ÎÑàÎ•º ÏúÑÌï¥) */
        .card-inner {
            padding: 20px
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px
        }

        .region-tag {
            font-size: 11px;
            font-weight: 800;
            color: var(--accent);
            letter-spacing: .5px;
            text-transform: uppercase;
            margin-bottom: 5px;
            opacity: .8
        }

        .site-name {
            font-size: 20px;
            font-weight: 900;
            letter-spacing: -.5px;
            line-height: 1.2
        }

        .total-badge {
            text-align: right
        }

        .total-badge .label {
            font-size: 10px;
            color: var(--dim);
            font-weight: 700;
            margin-bottom: 3px
        }

        .total-badge .val {
            font-size: 20px;
            font-weight: 900;
            color: var(--success)
        }

        /* ===== ÏïåÎ¶º UI ===== */
        /* Í≤ΩÍ≥†Îì± (M/AÏö©) */
        @keyframes blink {
            0% {
                opacity: 1
            }

            50% {
                opacity: .2
            }

            100% {
                opacity: 1
            }
        }

        .led-red {
            display: inline-block;
            font-size: 11px;
            margin-left: 6px;
            animation: blink 1s infinite;
            text-shadow: 0 0 8px rgba(248, 113, 113, .8)
        }

        /* Ï†ÑÍ¥ëÌåê (B/C/SÏö©) */
        .alert-banner {
            background: rgba(248, 113, 113, .12);
            border-bottom: 1px solid rgba(248, 113, 113, .2);
            color: var(--danger);
            font-size: 11px;
            font-weight: 900;
            padding: 7px 16px;
            display: flex;
            align-items: center;
            overflow: hidden;
            white-space: nowrap
        }

        .marquee-content {
            display: inline-block;
            animation: marquee 18s linear infinite
        }

        @keyframes marquee {
            0% {
                transform: translateX(100vw)
            }

            100% {
                transform: translateX(-100%)
            }
        }

        /* Ï£ºÏùò(ÎÖ∏Îûë) Ï†ÑÍ¥ëÌåê */
        .alert-banner.warn {
            background: rgba(251, 191, 36, .08);
            border-bottom-color: rgba(251, 191, 36, .2);
            color: var(--warning)
        }

        .stats-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            margin-bottom: 14px
        }

        .sbox {
            background: rgba(255, 255, 255, .02);
            border: 1px solid var(--border);
            border-radius: var(--r2);
            padding: 12px 8px;
            text-align: center;
            position: relative;
            transition: border-color .2s
        }

        .sbox:hover {
            border-color: rgba(255, 255, 255, .12)
        }

        .sbox .lb {
            font-size: 10px;
            color: var(--dim);
            font-weight: 700;
            margin-bottom: 5px;
            display: block
        }

        .sbox .vl {
            font-size: 16px;
            font-weight: 900;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block
        }

        .edit-sm {
            position: absolute;
            top: 5px;
            right: 5px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 10px;
            opacity: .3;
            transition: opacity .2s;
            padding: 2px
        }

        .edit-sm:hover {
            opacity: 1
        }

        .staff-panel {
            background: linear-gradient(135deg, rgba(56, 189, 248, .04), rgba(129, 140, 248, .03));
            border: 1px solid rgba(56, 189, 248, .08);
            border-radius: var(--r2);
            padding: 12px;
            margin-bottom: 14px;
            position: relative
        }

        .staff-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            text-align: center;
            gap: 4px
        }

        .staff-grid .lb {
            font-size: 10px;
            color: var(--dim);
            font-weight: 700;
            margin-bottom: 3px
        }

        .staff-grid .vl {
            font-size: 16px;
            font-weight: 900
        }

        .edit-icon {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(255, 255, 255, .04);
            border: 1px solid var(--border);
            border-radius: 8px;
            width: 26px;
            height: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
            transition: all .2s
        }

        .edit-icon:hover {
            background: rgba(56, 189, 248, .1);
            border-color: var(--accent)
        }

        /* ===== ÏõîÍ∞Ñ ÏöîÏïΩ Î∞î ===== */
        .monthly-bar {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 8px 0 12px;
            padding: 7px 12px;
            background: rgba(255, 255, 255, .02);
            border-radius: 10px;
            border: 1px dashed var(--border);
        }

        .mb-item {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            font-weight: 700;
            color: var(--dim);
            white-space: nowrap;
        }

        .mb-val {
            color: var(--text)
        }

        .mb-pct {
            font-weight: 900;
            font-size: 10px;
            padding: 1px 5px;
            border-radius: 4px;
        }

        .mb-pct.up {
            color: var(--success);
            background: rgba(52, 211, 153, .1)
        }

        .mb-pct.down {
            color: var(--danger);
            background: rgba(248, 113, 113, .1)
        }

        .mb-split {
            color: var(--border);
            font-size: 10px
        }

        .tbl-wrap {
            background: rgba(0, 0, 0, .25);
            border-radius: var(--r2);
            overflow: hidden;
            border: 1px solid var(--border);
            margin-bottom: 14px
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px
        }

        th {
            padding: 10px 8px;
            text-align: right;
            color: var(--dim);
            font-weight: 700;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: .5px;
            border-bottom: 1px solid var(--border);
            background: rgba(255, 255, 255, .01)
        }

        td {
            padding: 9px 8px;
            text-align: right;
            border-bottom: 1px solid rgba(255, 255, 255, .03);
            font-weight: 700
        }

        td:first-child,
        th:first-child {
            text-align: left
        }

        td:first-child {
            color: var(--accent);
            font-weight: 800
        }

        .row-sum td {
            background: rgba(52, 211, 153, .04);
            font-weight: 900;
            color: var(--success) !important
        }

        .btn-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px
        }

        .mbtn {
            height: 40px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: rgba(255, 255, 255, .02);
            color: var(--text);
            font-size: 12px;
            font-weight: 800;
            cursor: pointer;
            transition: all .2s
        }

        .mbtn:hover {
            border-color: rgba(255, 255, 255, .15);
            background: rgba(255, 255, 255, .05)
        }

        .mbtn.pri {
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            color: #fff;
            border: none;
            box-shadow: 0 2px 8px rgba(56, 189, 248, .15)
        }

        .mbtn.pri:hover {
            box-shadow: 0 4px 16px rgba(56, 189, 248, .25)
        }

        /* ===== INLINE PANELS ===== */
        .ipanel {
            display: none;
            margin-top: 14px;
            padding: 18px;
            background: rgba(10, 15, 30, .7);
            border: 1px solid var(--border);
            border-radius: var(--r2);
            animation: slideIn .25s ease-out;
            overflow: hidden;
            max-width: 100%;
            box-sizing: border-box
        }

        .ipanel.show {
            display: block
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-6px)
            }

            to {
                opacity: 1;
                transform: translateY(0)
            }
        }

        .sec-title {
            font-size: 12px;
            font-weight: 900;
            color: var(--accent);
            margin: 18px 0 10px;
            padding-bottom: 6px;
            border-bottom: 1px solid var(--border);
            letter-spacing: .3px
        }

        .sec-title:first-child {
            margin-top: 0
        }

        .fg {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 12px
        }

        .fg.c4 {
            grid-template-columns: 1fr 1fr 1fr 1fr
        }

        @media(max-width:400px) {
            .fg.c4 {
                grid-template-columns: 1fr 1fr
            }
        }

        .ff {
            display: flex;
            flex-direction: column;
            gap: 3px
        }

        .ff label {
            font-size: 10px;
            color: var(--dim);
            font-weight: 700
        }

        .ff input,
        .ff textarea {
            background: rgba(255, 255, 255, .03);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 9px 10px;
            color: #fff;
            font-size: 13px;
            font-weight: 700;
            outline: none;
            transition: border-color .2s;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            min-width: 0
        }

        .ff input:focus,
        .ff textarea:focus {
            border-color: var(--accent)
        }

        .ff textarea {
            resize: none;
            height: 56px
        }

        .sv-btn {
            width: 100%;
            height: 42px;
            border-radius: 10px;
            border: none;
            font-weight: 900;
            font-size: 13px;
            cursor: pointer;
            transition: all .2s;
            letter-spacing: -.2px
        }

        .sv-btn.green {
            background: linear-gradient(135deg, var(--success), #059669);
            color: #fff;
            box-shadow: 0 2px 10px rgba(52, 211, 153, .2)
        }

        .sv-btn.blue {
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            color: #fff;
            box-shadow: 0 2px 10px rgba(56, 189, 248, .15)
        }

        .sv-btn:disabled {
            opacity: .4
        }

        .sv-msg {
            text-align: center;
            font-size: 12px;
            margin-top: 8px;
            font-weight: 800
        }

        /* ===== REPORT OVERLAY ===== */
        .ov {
            position: fixed;
            inset: 0;
            background: rgba(10, 15, 30, .85);
            backdrop-filter: blur(12px);
            z-index: 1500;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 16px
        }

        .ov-box {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 28px 24px;
            width: 100%;
            max-width: 540px;
            max-height: 88vh;
            overflow-y: auto;
            box-shadow: 0 24px 64px rgba(0, 0, 0, .5)
        }

        .ov-hdr {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px
        }

        .ov-hdr h3 {
            font-size: 16px;
            font-weight: 900;
            letter-spacing: -.3px
        }

        .cls-btn {
            padding: 6px 14px;
            border-radius: 8px;
            background: rgba(255, 255, 255, .04);
            border: 1px solid var(--border);
            color: var(--muted);
            font-size: 11px;
            font-weight: 800;
            cursor: pointer;
            transition: all .2s
        }

        .cls-btn:hover {
            border-color: var(--accent);
            color: var(--accent)
        }

        .ch-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px
        }

        .ch-name {
            width: 48px;
            text-align: right;
            font-size: 11px;
            font-weight: 800;
            flex-shrink: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: var(--muted)
        }

        .ch-track {
            flex: 1;
            height: 24px;
            background: rgba(255, 255, 255, .03);
            border-radius: 6px;
            overflow: hidden;
            position: relative
        }

        .ch-fill {
            height: 100%;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 8px;
            font-size: 10px;
            font-weight: 900;
            color: #fff;
            text-shadow: 0 1px 3px rgba(0, 0, 0, .4);
            min-width: 28px;
            transition: width .6s ease-out
        }

        .ch-dual {
            display: flex;
            gap: 3px;
            margin-bottom: 3px
        }

        .ch-dual .ch-track {
            height: 18px
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 900
        }

        .note-box {
            background: linear-gradient(135deg, rgba(56, 189, 248, .03), rgba(129, 140, 248, .02));
            border: 1px solid rgba(56, 189, 248, .08);
            border-radius: var(--r2);
            padding: 16px;
            margin-top: 16px;
            font-size: 11px;
            color: var(--muted);
            line-height: 1.8
        }

        .note-box strong {
            color: var(--accent)
        }

        .note-box .formula {
            color: var(--dim);
            margin-left: 14px;
            display: block
        }

        /* ===== Ï∫òÎ¶∞Îçî ===== */
        .cal-modal {
            position: fixed;
            inset: 0;
            background: rgba(10, 15, 30, .92);
            backdrop-filter: blur(16px);
            z-index: 1600;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 16px
        }

        .cal-modal.show {
            display: flex
        }

        .cal-box {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 24px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 24px 64px rgba(0, 0, 0, .6)
        }

        .cal-hdr {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px
        }

        .cal-hdr h3 {
            font-size: 15px;
            font-weight: 900
        }

        .cal-nav {
            display: flex;
            align-items: center;
            gap: 12px
        }

        .cal-nav button {
            background: rgba(255, 255, 255, .04);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            width: 28px;
            height: 28px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all .2s
        }

        .cal-nav button:hover {
            border-color: var(--accent);
            color: var(--accent)
        }

        .cal-nav .mon-lbl {
            font-size: 13px;
            font-weight: 900;
            min-width: 80px;
            text-align: center
        }

        .cal-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 3px;
            margin-bottom: 16px
        }

        .cal-dow {
            text-align: center;
            font-size: 10px;
            font-weight: 800;
            color: var(--dim);
            padding: 4px 0
        }

        .cal-day {
            aspect-ratio: 1;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 11px;
            font-weight: 800;
            transition: all .2s;
            position: relative;
            gap: 1px
        }

        .cal-day:hover {
            background: rgba(56, 189, 248, .08)
        }

        .cal-day.has-data::after {
            content: '';
            width: 5px;
            height: 5px;
            background: var(--accent);
            border-radius: 50%;
            position: absolute;
            bottom: 3px
        }

        .cal-day.today {
            background: rgba(56, 189, 248, .1);
            border: 1px solid rgba(56, 189, 248, .3)
        }

        .cal-day.selected {
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            color: #fff
        }

        .cal-day.other-month {
            opacity: .25
        }

        .cal-detail {
            background: rgba(0, 0, 0, .3);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin-top: 8px;
            animation: slideIn .2s ease-out
        }

        .cal-detail .dt-title {
            font-size: 13px;
            font-weight: 900;
            color: var(--accent);
            margin-bottom: 12px
        }

        .cal-meal-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            margin-bottom: 8px
        }

        .cal-meal-box {
            background: rgba(255, 255, 255, .02);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px;
            text-align: center
        }

        .cal-meal-box .mlb {
            font-size: 9px;
            color: var(--dim);
            font-weight: 700;
            margin-bottom: 4px
        }

        .cal-meal-box .mval {
            font-size: 16px;
            font-weight: 900
        }

        .cal-meal-box .msub {
            font-size: 9px;
            color: var(--muted);
            margin-top: 2px
        }

        .emotion-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 22px;
            padding: 2px 6px;
            transition: transform .2s;
            display: inline-block
        }

        .emotion-btn:hover {
            transform: scale(1.25)
        }

        /* ===== Ï†ïÎ∞Ä Îç∞Ïù¥ÌÑ∞ ÏûÖÎ†• ===== */
        .precise-title {
            font-size: 11px;
            font-weight: 900;
            color: var(--accent2);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px
        }

        .meal-staff-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            margin-bottom: 10px
        }

        .meal-staff-cell {
            background: rgba(255, 255, 255, .02);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px;
            text-align: center
        }

        .meal-staff-cell .mc-lb {
            font-size: 9px;
            color: var(--dim);
            font-weight: 700;
            margin-bottom: 4px
        }

        .meal-staff-cell input {
            width: 100%;
            background: none;
            border: none;
            color: var(--accent);
            font-size: 15px;
            font-weight: 900;
            text-align: center;
            outline: none
        }

        .intensity-meter {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px
        }

        .intensity-bar {
            flex: 1;
            height: 8px;
            background: rgba(255, 255, 255, .05);
            border-radius: 4px;
            overflow: hidden
        }

        .intensity-fill {
            height: 100%;
            border-radius: 4px;
            transition: width .5s ease, background .5s
        }

        .sbox-auto {
            border-color: rgba(52, 211, 153, .25) !important;
            background: rgba(52, 211, 153, .03) !important
        }

        .auto-dot {
            position: absolute;
            top: 5px;
            left: 5px;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--success);
            display: block;
            box-shadow: 0 0 6px rgba(52, 211, 153, .5)
        }

        /* ===== Ï∂îÏù¥ Î∂ÑÏÑù Î¶¨Ìè¨Ìä∏ ===== */
        .trend-modal {
            position: fixed;
            inset: 0;
            background: rgba(10, 15, 30, .95);
            backdrop-filter: blur(20px);
            z-index: 1700;
            display: none;
            flex-direction: column
        }

        .trend-modal.show {
            display: flex
        }

        .trend-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(17, 24, 39, .9);
            flex-shrink: 0
        }

        .trend-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px 24px
        }

        .trend-section {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--r2);
            padding: 18px;
            margin-bottom: 16px
        }

        .trend-section-title {
            font-size: 12px;
            font-weight: 900;
            color: var(--accent);
            margin-bottom: 14px;
            letter-spacing: .3px
        }

        .sparkline-wrap {
            position: relative;
            overflow: hidden;
            border-radius: 8px
        }

        .kpi-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 14px
        }

        .kpi-box {
            background: rgba(255, 255, 255, .02);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px;
            text-align: center
        }

        .kpi-box .kl {
            font-size: 9px;
            color: var(--dim);
            font-weight: 700;
            margin-bottom: 4px
        }

        .kpi-box .kv {
            font-size: 18px;
            font-weight: 900
        }

        .kpi-box .kt {
            font-size: 10px;
            font-weight: 700;
            margin-top: 2px
        }

        .forecast-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 800;
            background: rgba(167, 139, 250, .1);
            color: var(--accent3);
            border: 1px solid rgba(167, 139, 250, .2)
        }

        .report-actions {
            display: flex;
            gap: 8px;
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            background: rgba(17, 24, 39, .9);
            flex-shrink: 0
        }

        .report-btn {
            flex: 1;
            height: 44px;
            border-radius: 10px;
            border: none;
            font-weight: 900;
            font-size: 13px;
            cursor: pointer;
            transition: all .2s
        }

        .report-btn.pri {
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            color: #fff
        }

        .report-btn.sec {
            background: rgba(255, 255, 255, .04);
            border: 1px solid var(--border);
            color: var(--text)
        }

        .data-table-mini {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px
        }

        .data-table-mini th {
            padding: 6px 8px;
            text-align: center;
            color: var(--dim);
            font-size: 9px;
            font-weight: 800;
            border-bottom: 1px solid var(--border);
            background: rgba(255, 255, 255, .01)
        }

        .data-table-mini td {
            padding: 6px 8px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, .03);
            font-weight: 700;
            font-size: 11px
        }

        .data-table-mini td:first-child {
            text-align: left;
            color: var(--accent);
            font-weight: 800
        }

        .trend-up {
            color: var(--success)
        }

        .trend-down {
            color: var(--danger)
        }

        .trend-flat {
            color: var(--warning)
        }

        .no-data-msg {
            text-align: center;
            padding: 30px;
            color: var(--dim);
            font-size: 13px
        }

        .goal-input {
            width: 100%;
            background: rgba(56, 189, 248, .06);
            border: 1.5px solid var(--accent);
            border-radius: 6px;
            padding: 4px 6px;
            color: #fff;
            font-size: 14px;
            font-weight: 900;
            text-align: center;
            outline: none;
            margin-top: 2px
        }
    </style>
</head>

<body>
    <!-- LOGIN -->
    <div id="login-overlay" class="login-overlay">
        <div class="login-bg"></div>
        <div class="login-card">
            <div class="login-logo">üè¢</div>
            <h2>Welstory Dashboard</h2>
            <p>Samsung Welstory Ïö¥ÏòÅ ÌòÑÌô© Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú<br />Ïù∏Í∞ÄÎêú Í¥ÄÍ≥ÑÏûêÎßå Ï†ëÍ∑º Í∞ÄÎä•Ìï©ÎãàÎã§</p>
            <div class="login-field">
                <input type="text" id="loginId" placeholder="Ïã±Í∏Ä ÏïÑÏù¥Îîî" autocomplete="off">
                <div class="domain-tag">@samsung.com</div>
            </div>
            <div style="display:flex;align-items:center;justify-content:flex-end;margin:-4px 0 10px;gap:6px">
                <span id="save-id-label" style="font-size:11px;color:var(--dim);font-weight:600"></span>
                <button id="save-id-btn" onclick="toggleSaveId()"
                    style="padding:4px 12px;border-radius:8px;border:1px solid var(--border);background:rgba(255,255,255,.04);color:var(--muted);font-size:11px;font-weight:800;cursor:pointer;transition:all .2s;line-height:1.4">ÏïÑÏù¥Îîî
                    Ï†ÄÏû•</button>
            </div>
            <input type="password" id="loginPw" placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏">
            <button class="login-btn" onclick="doLogin()">Î°úÍ∑∏Ïù∏</button>
            <div id="login-error"></div>
        </div>
    </div>

    <!-- SPLASH -->
    <div id="splash">
        <div style="font-size:20px;font-weight:900;color:#fff;margin-bottom:24px;letter-spacing:-.5px">Welstory
            Dashboard</div>
        <div class="sp-ring"></div>
        <div style="margin-top:20px;font-size:13px;color:var(--dim)">Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard">
        <header>
            <div class="header-top">
                <div>
                    <!-- ‚ë† Ìó§Îçî ÌÉÄÏù¥ÌãÄ: Í∂åÌïúÎ≥Ñ ÎèôÏ†Å Î≥ÄÍ≤Ω -->
                    <h1 id="main-title">Welstory ÏÇ¨ÏóÖÏû• ÌòÑÌô©</h1>
                    <div id="lastUpdate"></div>
                    <!-- Í∂åÌïú Î∞∞ÏßÄ -->
                    <div id="role-badge"></div>
                </div>
                <div class="hdr-btns">
                    <!-- ‚ë¢ M/A/BÎßå Î¶¨Ìè¨Ìä∏ Î≤ÑÌäº ÌëúÏãú (Í∏∞Î≥∏ Ïà®ÍπÄ, Í∂åÌïú ÌôïÏù∏ ÌõÑ Ï°∞Í±¥Î∂Ä ÌëúÏãú) -->
                    <button id="rpt-btn" class="hdr-btn accent" style="display:none" onclick="openReport()">üìä
                        Î¶¨Ìè¨Ìä∏</button>
                    <!-- ‚ë¢ M/AÎßå Ï∂îÏù¥ Î∂ÑÏÑù Ï†ëÍ∑º (C/S Ïà®ÍπÄ) -->
                    <button id="trend-btn" class="hdr-btn" onclick="openTrendReport()" title="Ï∂îÏù¥ Î∂ÑÏÑù Î¶¨Ìè¨Ìä∏">üìà</button>
                    <button class="hdr-btn" onclick="openCal()" title="Îç∞ÏùºÎ¶¨ ÏãùÏàò Ïó¥Îûå">üìÖ</button>
                    <button class="hdr-btn" onclick="location.reload()">‚Üª</button>
                    <button class="hdr-btn" onclick="openPwChange()" title="ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤Ω">üîë</button>
                </div>
            </div>
            <div class="filter-row" id="chips"></div>
        </header>
        <main id="grid"></main>
    </div>

    <!-- REPORT OVERLAY -->
    <div id="ov" class="ov" onclick="this.style.display='none'">
        <div class="ov-box" id="ov-ct" onclick="event.stopPropagation()"></div>
    </div>

    <!-- Îç∞ÏùºÎ¶¨ Ï∫òÎ¶∞Îçî Î™®Îã¨ -->
    <div id="cal-modal" class="cal-modal" onclick="this.classList.remove('show')">
        <div class="cal-box" onclick="event.stopPropagation()">
            <div class="cal-hdr">
                <h3>üìÖ Îç∞ÏùºÎ¶¨ ÏãùÏàò Ïó¥Îûå</h3>
                <button class="cls-btn"
                    onclick="document.getElementById('cal-modal').classList.remove('show')">Îã´Í∏∞</button>
            </div>
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px">
                <div class="cal-nav">
                    <button onclick="calPrev()">‚Äπ</button>
                    <div class="cal-nav">
                        <div class="mon-lbl" id="cal-month-lbl"></div>
                    </div>
                    <button onclick="calNext()">‚Ä∫</button>
                </div>
                <select id="cal-site-sel" onchange="renderCal()"
                    style="background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:8px;padding:6px 10px;color:var(--text);font-size:12px;font-weight:700;outline:none">
                    <option value="ALL">Ï†ÑÏ≤¥ ÏÇ¨ÏóÖÏû•</option>
                </select>
            </div>
            <div class="cal-grid" id="cal-days"></div>
            <div id="cal-detail"></div>
        </div>
    </div>

    <!-- ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤Ω Î™®Îã¨ -->
    <div id="pw-modal"
        style="display:none;position:fixed;inset:0;background:rgba(10,15,30,.92);backdrop-filter:blur(16px);z-index:1800;justify-content:center;align-items:center;padding:16px"
        onclick="this.style.display='none'">
        <div style="background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:28px 24px;width:100%;max-width:360px;box-shadow:0 24px 64px rgba(0,0,0,.5)"
            onclick="event.stopPropagation()">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                <div style="font-size:16px;font-weight:900;letter-spacing:-.3px">üîë ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤Ω</div>
                <button class="cls-btn" onclick="document.getElementById('pw-modal').style.display='none'">Îã´Í∏∞</button>
            </div>
            <div
                style="font-size:11px;color:var(--dim);margin-bottom:16px;line-height:1.6;background:rgba(56,189,248,.04);padding:10px 14px;border-radius:10px;border:1px solid rgba(56,189,248,.08)">
                ‚ÑπÔ∏è Í∞úÏù∏ ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏÑ§Ï†ïÌïòÎ©¥ ÎßàÏä§ÌÑ∞ ÎπÑÎ∞ÄÎ≤àÌò∏ ÎåÄÏã† ÏÇ¨Ïö©Îê©ÎãàÎã§.<br />ÏµúÏÜå 4Ïûê Ïù¥ÏÉÅ ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî.
            </div>
            <div class="ff" style="margin-bottom:10px"><label>ÌòÑÏû¨ ÎπÑÎ∞ÄÎ≤àÌò∏</label><input type="password" id="pw-cur"
                    placeholder="ÌòÑÏû¨ ÎπÑÎ∞ÄÎ≤àÌò∏ ÏûÖÎ†•"
                    style="background:rgba(255,255,255,.03);border:1px solid var(--border);border-radius:8px;padding:9px 10px;color:#fff;font-size:13px;font-weight:700;outline:none;width:100%;transition:border-color .2s"
                    onfocus="this.style.borderColor='var(--accent)'" onblur="this.style.borderColor='var(--border)'">
            </div>
            <div class="ff" style="margin-bottom:10px"><label>ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏</label><input type="password" id="pw-new"
                    placeholder="ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏ (4Ïûê Ïù¥ÏÉÅ)"
                    style="background:rgba(255,255,255,.03);border:1px solid var(--border);border-radius:8px;padding:9px 10px;color:#fff;font-size:13px;font-weight:700;outline:none;width:100%;transition:border-color .2s"
                    onfocus="this.style.borderColor='var(--accent)'" onblur="this.style.borderColor='var(--border)'">
            </div>
            <div class="ff" style="margin-bottom:16px"><label>ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏ ÌôïÏù∏</label><input type="password" id="pw-confirm"
                    placeholder="ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏ Ïû¨ÏûÖÎ†•"
                    style="background:rgba(255,255,255,.03);border:1px solid var(--border);border-radius:8px;padding:9px 10px;color:#fff;font-size:13px;font-weight:700;outline:none;width:100%;transition:border-color .2s"
                    onfocus="this.style.borderColor='var(--accent)'" onblur="this.style.borderColor='var(--border)'">
            </div>
            <button onclick="submitPwChange()"
                style="width:100%;height:44px;border-radius:10px;border:none;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;font-weight:900;font-size:14px;cursor:pointer;transition:all .2s"
                onmouseover="this.style.opacity='.85'" onmouseout="this.style.opacity='1'">Î≥ÄÍ≤Ω ÏôÑÎ£å</button>
            <div id="pw-msg" style="text-align:center;font-size:12px;font-weight:800;margin-top:10px;min-height:18px">
            </div>
        </div>
    </div>

    <!-- Ï∂îÏù¥ Î∂ÑÏÑù Î¶¨Ìè¨Ìä∏ Î™®Îã¨ -->
    <div id="trend-modal" class="trend-modal">
        <div class="trend-header">
            <div>
                <div
                    style="font-size:18px;font-weight:900;letter-spacing:-.5px;background:linear-gradient(90deg,var(--accent),var(--accent3));-webkit-background-clip:text;-webkit-text-fill-color:transparent">
                    üìà Ï†ïÎ∞Ä Î∂ÑÏÑù Î¶¨Ìè¨Ìä∏</div>
                <div style="font-size:11px;color:var(--dim);margin-top:3px" id="trend-date-range"></div>
            </div>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end">
                <select id="trend-region-sel" onchange="renderTrendReport()"
                    style="background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:8px;padding:6px 10px;color:var(--text);font-size:12px;font-weight:700;outline:none;max-width:130px">
                    <option value="ALL">Ï†ÑÏ≤¥ ÏßÄÏó≠</option>
                </select>
                <span class="forecast-tag">‚ú® AI Ï∂îÏ†ï Ìè¨Ìï®</span>
                <button class="cls-btn" onclick="closeTrend()">Îã´Í∏∞</button>
            </div>
        </div>
        <div class="trend-body" id="trend-body"></div>
        <div class="report-actions" id="trend-actions">
            <!-- ‚ë¢ C/SÎäî Ï∂îÏ∂ú¬∑Î≥µÏÇ¨ Î≤ÑÌäº Ïà®ÍπÄ -->
            <button id="export-btn" class="report-btn pri" onclick="exportReport()">üì• Î¶¨Ìè¨Ìä∏ Ï∂îÏ∂ú (HTML)</button>
            <button id="sync-btn" class="report-btn sec" onclick="refreshTrendFromGAS()" title="ÏÑúÎ≤ÑÏùò Î™®Îì† Í≥ºÍ±∞ Ïã§Ï†ÅÍ≥º ÎèôÍ∏∞ÌôîÌï©ÎãàÎã§">üì°
                ÏÑúÎ≤Ñ ÎèôÍ∏∞Ìôî</button>
            <button id="copy-btn" class="report-btn sec" onclick="copyReportText()">üìã ÌÖçÏä§Ìä∏ Î≥µÏÇ¨</button>
            <button class="report-btn sec" onclick="closeTrend()">‚úï Îã´Í∏∞</button>
        </div>
    </div>

    <script>
        /* =====================================================
           ‚òÖ v2 Ï†ÑÏó≠ ÏÉÅÏàò & Í∂åÌïú Î≥ÄÏàò
        ===================================================== */
        const API = "https://script.google.com/macros/s/AKfycbxwJIGmBlO-bNYlwGpibBmP4cyBDYvGbpP9hWTxSabgNBGdUL5Ap24v1XqHVtscKgyk/exec";
        /* ‚ë† Ïó≠Îß§Ìïë: ÏÑúÎ≤Ñ ÎÇúÎèÖÌôî ÌÇ§ ‚Üí ÌïúÍ∏Ä ÌÇ§ */
        const RM = {
            "a": "ÏÇ¨ÏóÖÏû•Î™Ö", "b": "ÏßÄÏó≠",
            "c1": "ÏòÅÏñëÏÇ¨", "c2": "Ï°∞Î¶¨ÏÇ¨", "c3": "Ïõ∞ÌîÑÎ°ú_Ï£º", "c4": "Ïõ∞ÌîÑÎ°ú_Ïïº",
            "d1": "Ï¢åÏÑùÏàò", "d2": "ÏΩîÎÑàÏàò", "d3": "TO_ÏΩîÎÑàÏàò",
            "e1": "DI_Ï°∞Ïãù", "e2": "DI_Ï§ëÏãù", "e3": "DI_ÏÑùÏãù", "e4": "DI_ÏïºÏãù",
            "f1": "TO_Ï°∞Ïãù", "f2": "TO_Ï§ëÏãù", "f3": "TO_ÏÑùÏãù", "f4": "TO_ÏïºÏãù",
            "e5": "DI_Ï°∞Ïãù(Ï£ºÎßê)", "e6": "DI_Ï§ëÏãù(Ï£ºÎßê)", "e7": "DI_ÏÑùÏãù(Ï£ºÎßê)", "e8": "DI_ÏïºÏãù(Ï£ºÎßê)",
            "f5": "TO_Ï°∞Ïãù(Ï£ºÎßê)", "f6": "TO_Ï§ëÏãù(Ï£ºÎßê)", "f7": "TO_ÏÑùÏãù(Ï£ºÎßê)", "f8": "TO_ÏïºÏãù(Ï£ºÎßê)",
            "g1": "ÌöåÏ†ÑÏú®(Ï§ëÏãù_T/OÌè¨Ìï®)", "g2": "ÌöåÏ†ÑÏú®(Ï§ëÏãù_T/OÏ†úÏô∏)",
            "h1": "ÎèÑÏ†ÑÎß§Ï∂ú", "h2": "ÎèÑÏ†ÑÏòÅÏóÖÏù¥Ïùµ", "h3": "Î™©ÌëúÏû¨Î£åÎπÑ",
            "m1": "Í∏àÏõî_ÌèâÍ∑†Ï§ëÏãù", "m2": "Ï†ÑÏõîÎåÄÎπÑ", "m3": "Ï°∞ÏóÖÏùºÏàò"
        };
        function deobf(arr) { return arr.map(row => { const o = {}; Object.keys(row).forEach(k => { o[RM[k] || k] = row[k] }); return o }); }

        let D = [], USER = null, TK = null, REG = "ALL";
        let USER_ROLE = 'C';         // ‚òÖ Í∂åÌïú Îì±Í∏â (M/A/B/C/S)
        let USER_REGION = '';        // ‚òÖ Îã¥ÎãπÏßÄÏó≠
        let USER_SITE = '';          // ‚òÖ ÏÜåÏÜçÏÇ¨ÏóÖÏû•
        let OV = JSON.parse(sessionStorage.getItem("OV") || "{}");

        /* ‚òÖ GAS Ïã§Ï†Å Îç∞Ïù¥ÌÑ∞ Ï∫êÏãú (Ï∂îÏù¥ Î¶¨Ìè¨Ìä∏Ïö©) */
        let _gasPerfCache = null;   // Î°úÎî©Îêú ÏÑúÎ≤Ñ Ïã§Ï†Å Îç∞Ïù¥ÌÑ∞
        let _gasPerfLoading = false; // Î°úÎî© Ï§ë ÌîåÎûòÍ∑∏
        let _gasPerfLoaded = false;  // ÏµúÏ¥à Î°úÎìú ÏôÑÎ£å ÌîåÎûòÍ∑∏

        function so() { sessionStorage.setItem("OV", JSON.stringify(OV)); }
        function n(v) { if (v == null) return 0; const t = String(v).trim(); if (!t || t === "-") return 0; const x = parseFloat(t.replace(/[^0-9.-]/g, '')); return isFinite(x) ? x : 0; }
        function f(v) { const x = n(v); return x === 0 ? "-" : x.toLocaleString(); }
        function rc(v) { return v >= 3.5 ? "var(--danger)" : v >= 2.5 ? "var(--warning)" : "var(--success)"; }
        function ov(sn, k, fb) { return (OV[sn] && OV[sn][k] != null) ? Number(OV[sn][k]) : fb; }
        function gSt(d) { const sn = d["ÏÇ¨ÏóÖÏû•Î™Ö"]; return ov(sn, "ÏòÅÏñëÏÇ¨", n(d["ÏòÅÏñëÏÇ¨"])) + ov(sn, "Ï°∞Î¶¨ÏÇ¨", n(d["Ï°∞Î¶¨ÏÇ¨"])) + ov(sn, "Ïõ∞ÌîÑÎ°ú_Ï£º", n(d["Ïõ∞ÌîÑÎ°ú_Ï£º"])) + ov(sn, "Ïõ∞ÌîÑÎ°ú_Ïïº", n(d["Ïõ∞ÌîÑÎ°ú_Ïïº"])); }
        function gMS(sn, m) { const o = OV[sn]; if (o && o[m + "_ÌèâÏùº"] > 0) return Number(o[m + "_ÌèâÏùº"]); const d = D.find(x => x["ÏÇ¨ÏóÖÏû•Î™Ö"] === sn); return d ? gSt(d) : 1; }
        function gSeats(d) { return ov(d["ÏÇ¨ÏóÖÏû•Î™Ö"], "Ï¢åÏÑùÏàò", n(d["Ï¢åÏÑùÏàò"])); }
        function inten(d) { const st = gSt(d) || 1, tm = ["Ï°∞Ïãù", "Ï§ëÏãù", "ÏÑùÏãù", "ÏïºÏãù"].reduce((a, m) => a + n(d["DI_" + m]) + n(d["TO_" + m]), 0); return { s: tm / st, tm, st }; }
        function iLb(s) { if (s >= 95) return { t: "Í≥ºÎ∂ÄÌïò", e: "üî¥", c: "var(--danger)", b: "rgba(248,113,113,.1)" }; if (s >= 80) return { t: "Ï£ºÏùò", e: "üü°", c: "var(--warning)", b: "rgba(251,191,36,.1)" }; return { t: "ÏñëÌò∏", e: "üü¢", c: "var(--success)", b: "rgba(52,211,153,.1)" }; }

        /* =====================================================
           ‚òÖ Í∂åÌïúÎ≥Ñ UI Ï†úÏñ¥ Ìï®Ïàò
        ===================================================== */
        const ROLE_LABEL = { M: "ÎßàÏä§ÌÑ∞", A: "ÏßÄÏó≠Ïû•", B: "PM", C: "Îã¥ÎãπÏûê", S: "Ïä§ÌÉ≠" };
        const ROLE_COLOR = { M: "#f87171", A: "#fbbf24", B: "#38bdf8", C: "#34d399", S: "#818cf8" };

        function applyRoleUI() {
            /* Ìó§Îçî ÌÉÄÏù¥ÌãÄ ÎèôÏ†Å Î≥ÄÍ≤Ω */
            const titleEl = document.getElementById("main-title");
            if (USER_ROLE === "M") titleEl.textContent = "Ï†ÑÏ≤¥ ÏÇ¨ÏóÖÏû• ÌòÑÌô©";
            else if (USER_ROLE === "A" || USER_ROLE === "B") titleEl.textContent = `${USER_REGION} ÏÇ¨ÏóÖÏû• ÌòÑÌô©`;
            else titleEl.textContent = USER_SITE || "ÎÇ¥ ÏÇ¨ÏóÖÏû• ÌòÑÌô©";

            /* Í∂åÌïú Î∞∞ÏßÄ */
            const badge = document.getElementById("role-badge");
            const col = ROLE_COLOR[USER_ROLE] || "#64748b";
            const lbl = ROLE_LABEL[USER_ROLE] || USER_ROLE;
            badge.style.cssText = `display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:6px;font-size:10px;font-weight:800;margin-top:4px;border:1px solid ${col}40;color:${col};background:${col}12`;
            badge.textContent = `‚óè ${lbl}`;

            /* ‚ë¢ Î¶¨Ìè¨Ìä∏¬∑Ï∂úÎ†• Î≤ÑÌäº Í∂åÌïú Ï†úÏñ¥ */
            const canReport = ["M", "A", "B"].includes(USER_ROLE);
            const canExport = ["M", "A"].includes(USER_ROLE);

            // Ï∂îÏù¥ Î∂ÑÏÑù Î≤ÑÌäº (C/S Ïà®ÍπÄ)
            document.getElementById("trend-btn").style.display = canReport ? "flex" : "none";
            // Ï∂îÏ∂ú¬∑Î≥µÏÇ¨ Î≤ÑÌäº (M/AÎßå)
            document.getElementById("export-btn").style.display = canExport ? "flex" : "none";
            document.getElementById("copy-btn").style.display = canExport ? "flex" : "none";
        }

        /* =====================================================
           ‚òÖ ÏïåÎ¶º Ìä∏Î¶¨Í±∞ ÌåêÎã® Ìï®Ïàò
           Í∏∞Ï§Ä ‚ë†: ÏßÅÏ†Ñ 5Í∞ú Í∏∞Î°ù ÎåÄÎπÑ Ï§ëÏãù ¬±15% Ïù¥ÏÉÅ Î≥ÄÎèô
           Í∏∞Ï§Ä ‚ë°: ÌöåÏ†ÑÏú® 2.5 Ïù¥ÏÉÅ (Í≥ºÎ∂ÄÌïò)
        ===================================================== */
        /* =====================================================
           ‚òÖ ÏßïÍ≤ÄÎã§Î¶¨ Ìú¥Ïùº ÏûêÎèô Í∞êÏßÄ (ÏïåÎûå ÏòàÏô∏ Ï≤òÎ¶¨)
           - ÏßïÍ≤ÄÎã§Î¶¨ Ìú¥Ïùº: Í≥µÌú¥Ïùº ÏÇ¨Ïù¥Ïóê ÎÅºÏñ¥ ÏûàÎäî ÌèâÏùº
           - Í∞ÑÏù¥ ÌåêÎã®: Ï£ºÎ≥Ä 1~2ÏùºÏù¥ ÌÜ†ÏùºÏù¥Í≥† Ìï¥ÎãπÏùºÏù¥ ÌèâÏùºÏù∏ Í≤ΩÏö∞
           - Ï†ïÌôïÌïú Í≥µÌú¥Ïùº Î™©Î°ùÏù¥ ÏóÜÏúºÎØÄÎ°ú Ìå®ÌÑ¥ Í∏∞Î∞ò Í∞êÏßÄ ÏÇ¨Ïö©
        ===================================================== */
        /* ===== ‚ë§ ÌïúÍµ≠ Í≥µÌú¥Ïùº/ÏßïÍ≤ÄÎã§Î¶¨(ÏÉåÎìúÏúÑÏπò) Ïù∏ÏßÄ =====
           - Ï£ºÏùò: ÏùåÎ†• Í≥µÌú¥Ïùº/ÎåÄÏ≤¥Í≥µÌú¥ÏùºÏùÄ Îß§ÎÖÑ Î≥ÄÎèôÎê©ÎãàÎã§.
           - Ïö¥ÏòÅ Î∞©Ïãù: Ïó∞ÎßêÏóê KOR_HOLIDAYS_BY_YEAR[YYYY]Îßå ÏóÖÎç∞Ïù¥Ìä∏ÌïòÎ©¥ Îê©ÎãàÎã§.
           - 'ÏßïÍ≤ÄÎã§Î¶¨' Ï†ïÏùò(ÏóÑÍ≤©): ÌèâÏùº(Í∑ºÎ¨¥Ïùº)Ïù¥Î©¥ÏÑú Ï†ÑÎÇ†Í≥º Îã§ÏùåÎÇ†Ïù¥ Î™®Îëê 'Ìú¥Î¨¥(Ï£ºÎßê/Í≥µÌú¥Ïùº)'Ïù∏ Í≤ΩÏö∞
        */
        const KOR_HOLIDAYS_BY_YEAR = {
            2026: [
                "2026-01-01", // Ïã†Ï†ï
                "2026-02-16", "2026-02-17", "2026-02-18", // ÏÑ§ÎÇ† Ïó∞Ìú¥
                "2026-03-01", "2026-03-02", // 3.1Ï†à(Ïùº) + ÎåÄÏ≤¥Í≥µÌú¥Ïùº
                "2026-05-05", // Ïñ¥Î¶∞Ïù¥ÎÇ†
                "2026-05-24", "2026-05-25", // Î∂ÄÏ≤òÎãòÏò§Ïã†ÎÇ†(Ïùº) + ÎåÄÏ≤¥Í≥µÌú¥Ïùº
                "2026-06-03", // Ï†ÑÍµ≠ÎèôÏãúÏßÄÎ∞©ÏÑ†Í±∞(ÏòàÏ†ï) ‚ÄªÎ≤ïÏ†ïÍ≥µÌú¥Ïùº
                "2026-06-06", // ÌòÑÏ∂©Ïùº(ÌÜ†) ‚ÄªÎåÄÏ≤¥Í≥µÌú¥Ïùº ÏóÜÏùå
                "2026-08-15", "2026-08-17", // Í¥ëÎ≥µÏ†à(ÌÜ†) + ÎåÄÏ≤¥Í≥µÌú¥Ïùº
                "2026-09-24", "2026-09-25", "2026-09-26", // Ï∂îÏÑù Ïó∞Ìú¥
                "2026-10-03", "2026-10-05", // Í∞úÏ≤úÏ†à(ÌÜ†) + ÎåÄÏ≤¥Í≥µÌú¥Ïùº
                "2026-10-09", // ÌïúÍ∏ÄÎÇ†
                "2026-12-25"  // ÏÑ±ÌÉÑÏ†à
            ]
        };

        function _toYMD(d) {
            const x = (d instanceof Date) ? d : new Date(d);
            if (isNaN(x.getTime())) return "";
            const y = x.getFullYear();
            const m = String(x.getMonth() + 1).padStart(2, '0');
            const dd = String(x.getDate()).padStart(2, '0');
            return `${y}-${m}-${dd}`;
        }
        function _isWeekend(ymd) {
            const d = new Date(ymd + "T00:00:00");
            const day = d.getDay();
            return (day === 0 || day === 6);
        }
        function _isHoliday(ymd) {
            const y = Number(String(ymd).slice(0, 4));
            const list = KOR_HOLIDAYS_BY_YEAR[y] || [];
            return list.includes(ymd);
        }
        function getHolidayType(ymd) {
            if (!ymd) return { type: "workday", label: "ÌèâÏùº" };
            if (_isWeekend(ymd)) return { type: "weekend", label: "Ï£ºÎßê" };
            if (_isHoliday(ymd)) return { type: "holiday", label: "Í≥µÌú¥Ïùº" };

            // ÏóÑÍ≤© ÏßïÍ≤ÄÎã§Î¶¨: Ï†ÑÎÇ†/Îã§ÏùåÎÇ†Ïù¥ Î™®Îëê Ìú¥Î¨¥(Ï£ºÎßê/Í≥µÌú¥Ïùº)
            const d = new Date(ymd + "T00:00:00");
            const prev = new Date(d); prev.setDate(d.getDate() - 1);
            const next = new Date(d); next.setDate(d.getDate() + 1);
            const p = _toYMD(prev), n = _toYMD(next);

            const isOff = (s) => _isWeekend(s) || _isHoliday(s);
            if (isOff(p) && isOff(n)) {
                return { type: "sandwich", label: "ÏßïÍ≤ÄÎã§Î¶¨" };
            }
            return { type: "workday", label: "ÌèâÏùº" };
        }

        function getAlertStatus(sn) {
            const recs = getRec().filter(r => r.siteName === sn).sort((a, b) => a.date > b.date ? -1 : 1);
            const d = D.find(x => x["ÏÇ¨ÏóÖÏû•Î™Ö"] === sn);
            let trigger = false, level = "warn", msg = "";

            /* Í∏∞Ï§Ä ‚ë°: ÌöåÏ†ÑÏú® Í≤ΩÍ≥† Î°úÏßÅ Ï†úÍ±∞ (ÏÇ¨Ïö©Ïûê ÏöîÏ≤≠: T/O Ìè¨Ìï® ÌöåÏ†ÑÏú® Í≤ΩÍ≥† Ï†úÏô∏) 
            if (d) {
                const diMid = n(d["DI_Ï§ëÏãù"]), toMid = n(d["TO_Ï§ëÏãù"]);
                const seats = gSeats(d) || 1;
                const ri = (n(d["ÌöåÏ†ÑÏú®(Ï§ëÏãù_T/OÌè¨Ìï®)"]) || 0) || (diMid + toMid) / seats;
                if (ri >= 3.5) { trigger = true; level = "danger"; msg = `‚ö†Ô∏è ÌöåÏ†ÑÏú® Í≥ºÎ∂ÄÌïò Í∞êÏßÄ (${ri.toFixed(1)}ÌöåÏ†Ñ) ‚Äî Ï¢åÏÑù Ïö¥ÏòÅ Ï†êÍ≤Ä ÌïÑÏöî`; }
            }
            */

            /* Í∏∞Ï§Ä ‚ë†: Ï§ëÏãù ¬±15% Ïù¥ÏÉÅ Î≥ÄÎèô (ÏµúÍ∑º 5Ïùº ÌèâÍ∑† ÎåÄÎπÑ Ïò§Îäò) */
            if (!trigger && recs.length >= 3) {
                const todayStr = recs[0].date;
                const dayInfo = getHolidayType(todayStr); // weekend/holiday/sandwich/workday

                const vals = recs.slice(1, 6).map(r => (r.DI_Ï§ëÏãù || 0) + (r.TO_Ï§ëÏãù || 0));
                const avg = vals.reduce((a, b) => a + b, 0) / vals.length;
                const today = (recs[0].DI_Ï§ëÏãù || 0) + (recs[0].TO_Ï§ëÏãù || 0);

                if (avg > 0) {
                    const chg = (today - avg) / avg * 100;
                    if (Math.abs(chg) >= 15) {
                        trigger = true;

                        // Í∏∞Î≥∏ Î†àÎ≤®/Î©îÏãúÏßÄ
                        level = chg > 0 ? "warn" : "danger";
                        msg = chg > 0
                            ? `üìà Ï§ëÏãù Í∏âÏ¶ù Í∞êÏßÄ (+${chg.toFixed(0)}%) ‚Äî ÏãùÏû¨Î£å Î∞úÏ£º Ï†êÍ≤Ä ÏöîÎßù`
                            : `üìâ Ï§ëÏãù Í∏âÍ∞ê Í∞êÏßÄ (${chg.toFixed(0)}%) ‚Äî ÏõêÏù∏ Î∂ÑÏÑù ÌïÑÏöî`;

                        // ‚ú® ÏòàÏô∏ Ï≤òÎ¶¨: Ìú¥Î¨¥/ÏßïÍ≤ÄÎã§Î¶¨Î°ú Ïù∏Ìïú 'Í∞êÏÜå'Îäî Í≤ΩÍ≥† Îã®Í≥ÑÎ•º ÏôÑÌôî
                        if (chg < 0 && (dayInfo.type === "sandwich" || dayInfo.type === "holiday" || dayInfo.type === "weekend")) {
                            level = "warn";
                            const tag = (dayInfo.type === "sandwich") ? "ÏßïÍ≤ÄÎã§Î¶¨" : dayInfo.label;
                            msg = `üìâ Ï§ëÏãù Í∞êÏÜå Í∞êÏßÄ (${chg.toFixed(0)}%) ‚Äî ${tag} ÏòÅÌñ• Ï∂îÏ†ï`;
                        }
                    }
                }
            }
            return { trigger, level, msg };
        }

        /* =====================================================
           ‚òÖ LOGIN
        ===================================================== */
        window.doLogin = async function () {
            const err = document.getElementById("login-error"); err.style.display = "none";
            const id = document.getElementById("loginId").value.trim(), pw = document.getElementById("loginPw").value, btn = document.querySelector(".login-btn");
            if (!id || !pw) { err.innerText = "ÏïÑÏù¥ÎîîÏôÄ ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî."; err.style.display = "block"; return; }
            btn.innerText = "Ï†ëÏÜç Ï§ë..."; btn.disabled = true;
            try {
                /* ‚òÖ GAS ÏùëÎãµ: "Valid|TOKEN|ROLE|REGION|SITE" */
                const r = await fetch(API + "?type=login&userId=" + encodeURIComponent(id) + "&pw=" + encodeURIComponent(pw));
                const t = await r.text();
                if (t.startsWith("Valid")) {
                    const parts = t.split("|");
                    USER = id; TK = parts[1] || null;
                    USER_ROLE = parts[2] || "C";
                    USER_REGION = parts[3] || "";
                    USER_SITE = parts[4] || "";
                    try {
                        sessionStorage.setItem("WS", id);
                        if (TK) sessionStorage.setItem("WTK", TK);
                        sessionStorage.setItem("WR", USER_ROLE);
                        sessionStorage.setItem("WRG", USER_REGION);
                        sessionStorage.setItem("WST", USER_SITE);
                    } catch (e) { }
                    document.getElementById("login-overlay").style.display = "none";
                    applyRoleUI();
                    init();
                    setTimeout(() => initSecurity(id), 500);
                } else {
                    err.innerText = t === "NoPermission" ? "Îì±Î°ùÎêòÏßÄ ÏïäÏùÄ Í≥ÑÏ†ïÏûÖÎãàÎã§." : "ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§.";
                    err.style.display = "block";
                }
            } catch (e) { err.innerText = "ÌÜµÏã† Ïò§Î•ò: " + e.message; err.style.display = "block"; }
            btn.innerText = "Î°úÍ∑∏Ïù∏"; btn.disabled = false;
        };

        /* =====================================================
           ‚òÖ DATA LOAD
        ===================================================== */
        async function init() {
            const sp = document.getElementById("splash"), db = document.getElementById("dashboard");
            sp.style.display = "flex";
            try {
                /* ‚òÖ tkÏóê role Ï†ïÎ≥¥ÎèÑ Ìï®Íªò Ï†ÑÎã¨ (GASÍ∞Ä ÌïÑÌÑ∞ÎßÅ) */
                const url = TK ? API + "?tk=" + TK : API + "?pw=" + encodeURIComponent(document.getElementById("loginPw").value);
                const r = await fetch(url);
                const raw = await r.json();
                if (raw.error) throw new Error(raw.error);

                /* ‚òÖ GASÍ∞Ä {role, region, site, data:[...]} ÌòïÌÉúÎ°ú ÏùëÎãµ */
                if (raw.data) {
                    D = deobf(raw.data);
                    if (!USER_ROLE || USER_ROLE === "C") { USER_ROLE = raw.role || "C"; USER_REGION = raw.region || ""; USER_SITE = raw.site || ""; }
                } else {
                    D = deobf(raw || []);
                }
                applyRoleUI();
                chips(); render();
                const now = new Date();
                document.getElementById("lastUpdate").innerText = `${now.getHours()}:${String(now.getMinutes()).padStart(2, "0")} ÏóÖÎç∞Ïù¥Ìä∏`;
                sp.style.opacity = "0";
                setTimeout(() => { sp.style.display = "none"; db.style.display = "flex"; db.style.opacity = "1"; }, 400);
            } catch (e) {
                sp.style.display = "none"; db.style.display = "flex"; db.style.opacity = "1";
                document.getElementById("grid").innerHTML = `<div style="padding:50px 20px;text-align:center"><div style="font-size:36px;margin-bottom:16px">‚ö†Ô∏è</div><p style="color:var(--muted);font-size:14px;margin-bottom:20px">${e.message}</p><button class="sv-btn blue" style="width:auto;padding:0 32px" onclick="location.reload()">Îã§Ïãú ÏãúÎèÑ</button></div>`;
            }
        }

        /* =====================================================
           ‚òÖ CHIPS & RENDER
        ===================================================== */
        function chips() {
            const rg = [...new Set(D.map(d => d["ÏßÄÏó≠"]))].filter(Boolean);
            /* C/SÎäî ÏßÄÏó≠ ÌÉ≠ Ïà®ÍπÄ (Î≥∏Ïù∏ ÏÇ¨ÏóÖÏû•Îßå Î≥¥ÏûÑ) */
            const showChips = ["M", "A", "B"].includes(USER_ROLE);
            document.getElementById("chips").innerHTML = showChips
                ? [{ v: "ALL", l: "Ï†ÑÏ≤¥" }, ...rg.map(r => ({ v: r, l: r }))].map(c => `<button class="chip ${REG === c.v ? " active" : ""}" onclick="setR('${c.v}')">${c.l}</button>`).join("")
                : "";
        }
        window.setR = function (r) { REG = r; chips(); render(); };

        function render() {
            const g = document.getElementById("grid");
            const fd = D.filter(d => REG === "ALL" || d["ÏßÄÏó≠"] === REG);

            /* ‚ë¢ Î¶¨Ìè¨Ìä∏ Î≤ÑÌäº: M/A/BÏù¥Í≥† ÏßÄÏó≠ ÏÑ†ÌÉù ÏãúÎßå ÌëúÏãú */
            const canReport = ["M", "A", "B"].includes(USER_ROLE);
            document.getElementById("rpt-btn").style.display = (canReport && REG !== "ALL") ? "flex" : "none";

            g.innerHTML = fd.map((d, i) => {
                const sn = d["ÏÇ¨ÏóÖÏû•Î™Ö"], rg = d["ÏßÄÏó≠"], u = sn.replace(/[^a-zA-Z0-9Í∞Ä-Ìû£]/g, '') + '_' + i;
                const gS = m => n(d["DI_" + m]) + n(d["TO_" + m]);
                const st = gSt(d);
                const seats = n(d["Ï¢åÏÑùÏàò"]);
                const seats_v = seats || 1;
                const diMid = n(d["DI_Ï§ëÏãù"]);
                const toMid = n(d["TO_Ï§ëÏãù"]);
                const corners = n(d["ÏΩîÎÑàÏàò"]) || 1;
                const toCorners_v = n(d["TO_ÏΩîÎÑàÏàò"]) || corners || 1;

                const ri_raw = n(d["ÌöåÏ†ÑÏú®(Ï§ëÏãù_T/OÌè¨Ìï®)"]);
                const re_raw = n(d["ÌöåÏ†ÑÏú®(Ï§ëÏãù_T/OÏ†úÏô∏)"]);

                const re = re_raw > 0 ? re_raw : (diMid / seats_v);
                const ri = ri_raw > 0 ? ri_raw : ((diMid + (toMid / toCorners_v)) / seats_v);
                const reAuto = re_raw === 0 && seats_v > 0 && diMid > 0, riAuto = ri_raw === 0 && seats_v > 0 && (diMid + toMid) > 0;
                const o = OV[sn] || {}, meals = ["Ï°∞Ïãù", "Ï§ëÏãù", "ÏÑùÏãù", "ÏïºÏãù"];
                let gR = ''; meals.forEach(m => { const di = n(d["DI_" + m]), to = n(d["TO_" + m]), tot = di + to, ms = gMS(sn, m), ps = (tot / ms).toFixed(1); gR += `<tr><td>${m}</td><td>${f(di)}</td><td>${f(to)}</td><td>${f(tot)}</td><td>${ms}</td><td style="color:var(--accent);font-weight:900">${ps}</td></tr>`; });
                const rS = D.filter(x => x["ÏßÄÏó≠"] === rg), mxL = Math.max(...rS.map(x => n(x["DI_Ï§ëÏãù"]) + n(x["TO_Ï§ëÏãù"])));
                let cB = ''; if (rS.length > 1) { cB = `<div class="sec-title">üìä ${rg} Ï§ëÏãù ÎπÑÍµê</div>`; rS.forEach(r => { const l = n(r["DI_Ï§ëÏãù"]) + n(r["TO_Ï§ëÏãù"]), p = mxL > 0 ? (l / mxL * 100) : 0, c = r["ÏÇ¨ÏóÖÏû•Î™Ö"] === sn; cB += `<div class="ch-bar"><div class="ch-name" style="${c ? 'color:var(--accent)' : ''}">${r["ÏÇ¨ÏóÖÏû•Î™Ö"]}</div><div class="ch-track"><div class="ch-fill" style="width:${p}%;background:${c ? 'linear-gradient(90deg,var(--accent),var(--accent2))' : 'rgba(100,116,139,.4)'}">${f(l)}</div></div></div>`; }); }
                const eF = meals.map(m => `<div class="ff"><label>${m} ÌèâÏùº</label><input type="number" id="ov_${u}_${m}_ÌèâÏùº" value="${o[m + '_ÌèâÏùº'] || ''}" placeholder="${st}"></div><div class="ff"><label>${m} Ï£ºÎßê</label><input type="number" id="ov_${u}_${m}_Ï£ºÎßê" value="${o[m + '_Ï£ºÎßê'] || ''}" placeholder="${st}"></div>`).join('');

                /* ‚ë° ÏïåÎ¶º ÌåêÎã® */
                const alert = getAlertStatus(sn);
                let alertBanner = '', ledDot = '';
                if (alert.trigger) {
                    if (["M", "A"].includes(USER_ROLE)) {
                        ledDot = `<span class="led-red" title="${alert.msg}">üî¥</span>`;
                    } else {
                        const bCls = alert.level === "danger" ? "" : "warn";
                        alertBanner = `<div class="alert-banner ${bCls}"><div class="marquee-content">${alert.msg}</div></div>`;
                    }
                }

                /* ÎàÑÏ†Å ÏöîÏïΩ Îç∞Ïù¥ÌÑ∞ ÌååÏã± */
                const mAvg = n(d["Í∏àÏõî_ÌèâÍ∑†Ï§ëÏãù"]), mMom = n(d["Ï†ÑÏõîÎåÄÎπÑ"]);
                const momClass = mMom > 0 ? "up" : (mMom < 0 ? "down" : "");
                const momIcon = mMom > 0 ? "‚Üë" : (mMom < 0 ? "‚Üì" : "‚Üí");

                /* ‚ë¢ Ïù∏Î†• ÏàòÏ†ï Ìå®ÎÑê: C/SÎäî Î≥¥Ïù¥ÏßÄ ÏïäÍ≤å */
                const canEdit = ["M", "A", "B"].includes(USER_ROLE);

                return `<div class="card">
            ${alertBanner}
            <div class="card-inner">
            <div class="card-header">
                <div>
                    <div class="region-tag">${rg}</div>
                    <div class="site-name">${sn} ${ledDot} <button class="emotion-btn" onclick="openCalForSite('${sn}')" title="Îç∞ÏùºÎ¶¨ ÏãùÏàò Ïó¥Îûå">üìÜ</button></div>
                    <div class="monthly-bar">
                        <div class="mb-item"><span>üìä Í∏àÏõî ÌèâÍ∑†</span><span class="mb-val">${mAvg > 0 ? f(mAvg) + 'Ïãù' : '-'}</span></div>
                        <div class="mb-split">|</div>
                        <div class="mb-item"><span>Ï†ÑÏõîÎåÄÎπÑ</span><span class="mb-pct ${momClass}">${momIcon} ${Math.abs(mMom)}%</span></div>
                    </div>
                </div>
                <div class="total-badge"><div class="label">Ìà¨ÏûÖÏù∏Ïõê</div><div class="val">${st}<span style="font-size:12px;font-weight:700;opacity:.6">Î™Ö</span></div></div>
            </div>
            <div class="stats-row">
                <div class="sbox">${canEdit ? `<button class="edit-sm" onclick="tp('${u}','seat')">‚úèÔ∏è</button>` : ''}<span class="lb">Ï¢åÏÑù / ÏΩîÎÑà</span><span class="vl" style="font-size:14px;letter-spacing:-.5px">${f(seats)}<span style="color:var(--dim);font-size:11px;font-weight:600"> / </span>${f(corners)}</span>${(reAuto || riAuto) ? `<span style="font-size:8px;color:var(--success);display:block;margin-top:2px;font-weight:800">ÌöåÏ†ÑÏú® ÏûêÎèôÏÇ∞Ï∂ú Í∏∞Ï§Ä</span>` : ''}</div>
                <div class="sbox${reAuto ? ' sbox-auto' : ''}"><span class="lb">ÌöåÏ†ÑÏú® D/I</span><span class="vl" style="color:${rc(re)}">${re.toFixed(1)}</span>${reAuto ? `<span class="auto-dot" title="Ï¢åÏÑùÏàò Í∏∞Ï§Ä ÏûêÎèôÏÇ∞Ï∂ú"></span>` : ''}</div>
                <div class="sbox${riAuto ? ' sbox-auto' : ''}"><span class="lb">ÌöåÏ†ÑÏú® T/OÌè¨Ìï®</span><span class="vl" style="color:${rc(ri)}">${ri.toFixed(1)}</span>${riAuto ? `<span class="auto-dot" title="Ï¢åÏÑùÏàò Í∏∞Ï§Ä ÏûêÎèôÏÇ∞Ï∂ú"></span>` : ''}</div>
            </div>
            ${canEdit ? `<div id="p_seat_${u}" class="ipanel"><div class="sec-title" style="margin-top:0">‚úèÔ∏è Ï¢åÏÑù¬∑ÏΩîÎÑà ÏàòÏ†ï</div><div class="fg"><div class="ff"><label>Ï¢åÏÑùÏàò</label><input type="number" id="ov_${u}_Ï¢åÏÑùÏàò" value="${o['Ï¢åÏÑùÏàò'] || ''}" placeholder="${n(d['Ï¢åÏÑùÏàò'])}"></div><div class="ff"><label>ÏΩîÎÑàÏàò</label><input type="number" id="ov_${u}_ÏΩîÎÑàÏàò" value="${o['ÏΩîÎÑàÏàò'] || ''}" placeholder="${n(d['ÏΩîÎÑàÏàò'])}"></div><div class="ff"><label>TO_ÏΩîÎÑàÏàò</label><input type="number" id="ov_${u}_TO_ÏΩîÎÑàÏàò" value="${o['TO_ÏΩîÎÑàÏàò'] || ''}" placeholder="${n(d['TO_ÏΩîÎÑàÏàò']) || n(d['ÏΩîÎÑàÏàò'])}"></div></div><button class="sv-btn blue" onclick="svSeat('${u}','${sn}')">Ï†ÅÏö©</button></div>` : ''}
            <div class="staff-panel">
                ${canEdit ? `<div class="edit-icon" onclick="tp('${u}','edit')">‚úèÔ∏è</div>` : ''}
                <div style="font-size:10px;color:var(--dim);font-weight:700;margin-bottom:8px">Í∑ºÎ¨¥ Ïù∏Ïõê</div>
                <div class="staff-grid">
                    <div><div class="lb">ÏòÅÏñëÏÇ¨ / Ï°∞Î¶¨ÏÇ¨</div><div class="vl">${ov(sn, "ÏòÅÏñëÏÇ¨", n(d["ÏòÅÏñëÏÇ¨"]))} / ${ov(sn, "Ï°∞Î¶¨ÏÇ¨", n(d["Ï°∞Î¶¨ÏÇ¨"]))}</div></div>
                    <div><div class="lb">Ïõ∞ÌîÑÎ°ú Ï£º / Ïïº</div><div class="vl">${ov(sn, "Ïõ∞ÌîÑÎ°ú_Ï£º", n(d["Ïõ∞ÌîÑÎ°ú_Ï£º"]))} / ${ov(sn, "Ïõ∞ÌîÑÎ°ú_Ïïº", n(d["Ïõ∞ÌîÑÎ°ú_Ïïº"]))}</div></div>
                </div>
            </div>
            ${canEdit ? `<div id="p_edit_${u}" class="ipanel"><div class="sec-title" style="margin-top:0">‚úèÔ∏è Ïù∏Î†• ÏàòÏ†ï</div><div style="font-size:10px;color:var(--dim);margin-bottom:8px">Í∏∞Î≥∏ Ïù∏Ïõê</div>
                <div class="fg c4"><div class="ff"><label>ÏòÅÏñëÏÇ¨</label><input type="number" id="ov_${u}_ÏòÅÏñëÏÇ¨" value="${o['ÏòÅÏñëÏÇ¨'] || ''}" placeholder="${n(d['ÏòÅÏñëÏÇ¨'])}"></div><div class="ff"><label>Ï°∞Î¶¨ÏÇ¨</label><input type="number" id="ov_${u}_Ï°∞Î¶¨ÏÇ¨" value="${o['Ï°∞Î¶¨ÏÇ¨'] || ''}" placeholder="${n(d['Ï°∞Î¶¨ÏÇ¨'])}"></div><div class="ff"><label>Ïõ∞(Ï£º)</label><input type="number" id="ov_${u}_Ïõ∞ÌîÑÎ°ú_Ï£º" value="${o['Ïõ∞ÌîÑÎ°ú_Ï£º'] || ''}" placeholder="${n(d['Ïõ∞ÌîÑÎ°ú_Ï£º'])}"></div><div class="ff"><label>Ïõ∞(Ïïº)</label><input type="number" id="ov_${u}_Ïõ∞ÌîÑÎ°ú_Ïïº" value="${o['Ïõ∞ÌîÑÎ°ú_Ïïº'] || ''}" placeholder="${n(d['Ïõ∞ÌîÑÎ°ú_Ïïº'])}"></div></div>
                <div style="font-size:10px;color:var(--dim);margin:4px 0 8px">ÎÅºÎãàÎ≥Ñ Ìà¨ÏûÖÏù∏Ïõê</div><div class="fg">${eF}</div>
                <div class="precise-title">üéØ ÏóÖÎ¨¥Í∞ïÎèÑ Î≥¥Ï†ï Îç∞Ïù¥ÌÑ∞</div>
                <div class="meal-staff-grid">${meals.map(m => `<div class="meal-staff-cell"><div class="mc-lb">${m}Ïã§Ìà¨ÏûÖ</div><input type="number" id="ov_${u}_${m}_Ïã§Ìà¨ÏûÖ" value="${o[m + '_Ïã§Ìà¨ÏûÖ'] || ''}" placeholder="${gMS(sn, m)}" onchange="updateIntensity('${u}','${sn}')"></div>`).join('')}</div>
                <div class="intensity-meter" id="im_${u}">
                    <span style="font-size:10px;color:var(--dim);font-weight:700;min-width:52px">ÏóÖÎ¨¥Í∞ïÎèÑ</span>
                    <div class="intensity-bar"><div class="intensity-fill" id="ib_${u}" style="width:0%;background:var(--success)"></div></div>
                    <span id="iv_${u}" style="font-size:11px;font-weight:900;min-width:36px;text-align:right">-</span>
                </div>
                <button class="sv-btn blue" style="margin-top:10px" onclick="svEdit('${u}','${sn}')">Ï†ÅÏö© (Ïû¨Í≥ÑÏÇ∞)</button>
                <div id="ov_msg_${u}" class="sv-msg"></div>
            </div>`: ''}
            <div class="tbl-wrap"><table><thead><tr><th>Íµ¨Î∂Ñ</th><th>Ï°∞Ïãù</th><th>Ï§ëÏãù</th><th>ÏÑùÏãù</th><th>ÏïºÏãù</th></tr></thead><tbody>
                <tr><td>D/I</td><td>${f(d["DI_Ï°∞Ïãù"])}</td><td>${f(d["DI_Ï§ëÏãù"])}</td><td>${f(d["DI_ÏÑùÏãù"])}</td><td>${f(d["DI_ÏïºÏãù"])}</td></tr>
                <tr><td>T/O</td><td>${f(d["TO_Ï°∞Ïãù"])}</td><td>${f(d["TO_Ï§ëÏãù"])}</td><td>${f(d["TO_ÏÑùÏãù"])}</td><td>${f(d["TO_ÏïºÏãù"])}</td></tr>
                <tr class="row-sum"><td>Ìï©Í≥Ñ</td><td>${f(gS("Ï°∞Ïãù"))}</td><td>${f(gS("Ï§ëÏãù"))}</td><td>${f(gS("ÏÑùÏãù"))}</td><td>${f(gS("ÏïºÏãù"))}</td></tr>
            </tbody></table></div>
            <div class="btn-row">
                <button class="mbtn pri" onclick="tp('${u}','perf')">üìù Ïã§Ï†ÅÍ∏∞Î°ù</button>
                <button class="mbtn" onclick="tp('${u}','wknd')">üìÖ Ï£ºÎßêÌòÑÌô©</button>
                <button class="mbtn" onclick="tp('${u}','goal')">üéØ ÎèÑÏ†ÑÎ™©Ìëú</button>
            </div>
            <div id="p_perf_${u}" class="ipanel"><div class="sec-title" style="margin-top:0">üìù Ïã§Ï†Å Í∏∞Î°ù</div>
                <div class="fg"><div class="ff"><label>ÎÇ†Ïßú <span id="fmode_${u}" style="font-size:9px;color:var(--warning);font-weight:800"></span></label><input type="date" id="fd_${u}" value="${new Date().toISOString().slice(0, 10)}" onchange="loadPastRec('${u}','${sn}',this.value)"></div><div class="ff"><label>ÏÇ¨ÏóÖÏû•</label><input value="${sn}" disabled style="opacity:.5"></div></div>
                <div style="font-size:10px;color:var(--dim);font-weight:700;margin:4px 0">D/I</div>
                <div class="fg c4"><div class="ff"><label>Ï°∞</label><input type="number" id="fd1_${u}"></div><div class="ff"><label>Ï§ë</label><input type="number" id="fd2_${u}"></div><div class="ff"><label>ÏÑù</label><input type="number" id="fd3_${u}"></div><div class="ff"><label>Ïïº</label><input type="number" id="fd4_${u}"></div></div>
                <div style="font-size:10px;color:var(--dim);font-weight:700;margin:4px 0">T/O</div>
                <div class="fg c4"><div class="ff"><label>Ï°∞</label><input type="number" id="ft1_${u}"></div><div class="ff"><label>Ï§ë</label><input type="number" id="ft2_${u}"></div><div class="ff"><label>ÏÑù</label><input type="number" id="ft3_${u}"></div><div class="ff"><label>Ïïº</label><input type="number" id="ft4_${u}"></div></div>
                <div class="fg"><div class="ff"><label>ÎèÑÏ†ÑÎß§Ï∂ú</label><input type="number" id="fsl_${u}"></div><div class="ff"><label>Ïû¨Î£åÎπÑ</label><input type="number" id="fmt_${u}"></div></div>
                <div class="ff" style="margin-bottom:8px"><label>ÏãùÏÇ¨ ÌäπÏù¥</label><textarea id="fn1_${u}"></textarea></div>
                <div class="ff" style="margin-bottom:12px"><label>Í∏∞ÌÉÄ ÌäπÏù¥</label><textarea id="fn2_${u}"></textarea></div>
                <button class="sv-btn green" onclick="svRec('${u}','${sn}','${rg}')">üíæ Ï†ÄÏû•</button>
                <div id="fm_${u}" class="sv-msg"></div>
            </div>
            <div id="p_wknd_${u}" class="ipanel"><div class="sec-title" style="margin-top:0">üìÖ Ï£ºÎßê ÏãùÏàò</div>
                <div class="tbl-wrap"><table><thead><tr><th>Íµ¨Î∂Ñ</th><th>Ï°∞Ïãù</th><th>Ï§ëÏãù</th><th>ÏÑùÏãù</th><th>ÏïºÏãù</th></tr></thead><tbody>
                    <tr><td>D/I</td><td>${f(d["DI_Ï°∞Ïãù(Ï£ºÎßê)"])}</td><td>${f(d["DI_Ï§ëÏãù(Ï£ºÎßê)"])}</td><td>${f(d["DI_ÏÑùÏãù(Ï£ºÎßê)"])}</td><td>${f(d["DI_ÏïºÏãù(Ï£ºÎßê)"])}</td></tr>
                    <tr><td>T/O</td><td>${f(d["TO_Ï°∞Ïãù(Ï£ºÎßê)"])}</td><td>${f(d["TO_Ï§ëÏãù(Ï£ºÎßê)"])}</td><td>${f(d["TO_ÏÑùÏãù(Ï£ºÎßê)"])}</td><td>${f(d["TO_ÏïºÏãù(Ï£ºÎßê)"])}</td></tr>
                </tbody></table></div>
            </div>
            <div id="p_goal_${u}" class="ipanel"><div class="sec-title" style="margin-top:0">üéØ ÎèÑÏ†Ñ Î™©Ìëú</div>
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:14px">
                    <div class="sbox" style="cursor:pointer" onclick="toggleGoalEdit('${u}')"><span class="lb">ÎèÑÏ†ÑÎß§Ï∂ú ‚úèÔ∏è</span><span class="vl" style="color:var(--accent)" id="gv_Îß§Ï∂ú_${u}">${f(d["ÎèÑÏ†ÑÎß§Ï∂ú"])}</span><input type="number" id="gi_Îß§Ï∂ú_${u}" class="goal-input" style="display:none" value="${n(d['ÎèÑÏ†ÑÎß§Ï∂ú']) || ''}" placeholder="0" onchange="saveGoal('${u}','${sn}','Îß§Ï∂ú',this.value)"></div>
                    <div class="sbox" style="cursor:pointer" onclick="toggleGoalEdit('${u}')"><span class="lb">ÏòÅÏóÖÏù¥Ïùµ ‚úèÔ∏è</span><span class="vl" style="color:var(--success)" id="gv_Ïù¥Ïùµ_${u}">${f(d["ÎèÑÏ†ÑÏòÅÏóÖÏù¥Ïùµ"])}</span><input type="number" id="gi_Ïù¥Ïùµ_${u}" class="goal-input" style="display:none" value="${n(d['ÎèÑÏ†ÑÏòÅÏóÖÏù¥Ïùµ']) || ''}" placeholder="0" onchange="saveGoal('${u}','${sn}','Ïù¥Ïùµ',this.value)"></div>
                    <div class="sbox" style="cursor:pointer" onclick="toggleGoalEdit('${u}')"><span class="lb">Î™©ÌëúÏû¨Î£åÎπÑ ‚úèÔ∏è</span><span class="vl" style="color:var(--warning)" id="gv_Ïû¨Î£å_${u}">${f(d["Î™©ÌëúÏû¨Î£åÎπÑ"])}</span><input type="number" id="gi_Ïû¨Î£å_${u}" class="goal-input" style="display:none" value="${n(d['Î™©ÌëúÏû¨Î£åÎπÑ']) || ''}" placeholder="0" onchange="saveGoal('${u}','${sn}','Ïû¨Î£å',this.value)"></div>
                </div>
                <div id="goal-edit-hint-${u}" style="font-size:10px;color:var(--dim);text-align:center;margin-bottom:10px">üìù ÏàòÏπò ÌÑ∞Ïπò Ïãú ÏßÅÏ†ë ÏàòÏ†ï Í∞ÄÎä•</div>
                <div class="sec-title">üçΩÔ∏è Ïù∏ÏãúÎãπ ÏãùÏàò</div>
                <div class="tbl-wrap"><table><thead><tr><th>ÎÅºÎãà</th><th>D/I</th><th>T/O</th><th>Ìï©Í≥Ñ</th><th>Ìà¨ÏûÖ</th><th>Ïù∏ÏãúÎãπ</th></tr></thead><tbody>${gR}</tbody></table></div>
                ${cB}
                <div class="note-box"><strong>üìù Í≥ÑÏÇ∞</strong><br/>‚Ä¢ Ïù∏ÏãúÎãπ = (D/I+T/O) √∑ ÎÅºÎãàÎ≥Ñ Ìà¨ÏûÖÏù∏Ïõê<br/><span class="formula">‚úèÔ∏è ÎØ∏ÏÑ§Ï†ïÏãú Ï¥ùÏù∏Ïõê ${st}Î™Ö Ï†ÅÏö©</span><br/>‚Ä¢ ÏûêÎèô ÌöåÏ†ÑÏú® = Ï§ëÏãù ÏãùÏàò √∑ Ï¢åÏÑùÏàò (ÏõêÎ≥∏Í∞í ÏóÜÏùÑ Îïå)<br/><span class="formula">üü¢ Ï¥àÎ°ù ÌÖåÎëêÎ¶¨ + Ï†ê = ÏûêÎèô ÏÇ∞Ï∂ú Í∞í</span></div>
            </div>
            </div><!-- card-inner -->
        </div>`;
            }).join("");
        }

        /* =====================================================
           Í≥µÌÜµ Ïú†Ìã∏
        ===================================================== */
        window.tp = function (u, t) { ['perf', 'wknd', 'goal', 'edit', 'seat'].forEach(p => { const e = document.getElementById(`p_${p}_${u}`); if (e) { if (p === t) e.classList.toggle('show'); else e.classList.remove('show'); } }); };
        window.svSeat = function (u, sn) { OV[sn] = OV[sn] || {};['Ï¢åÏÑùÏàò', 'ÏΩîÎÑàÏàò', 'TO_ÏΩîÎÑàÏàò'].forEach(k => { const v = document.getElementById(`ov_${u}_${k}`).value; if (v) OV[sn][k] = Number(v); else delete OV[sn][k]; }); so(); render(); };
        window.svEdit = function (u, sn) { OV[sn] = OV[sn] || {};['ÏòÅÏñëÏÇ¨', 'Ï°∞Î¶¨ÏÇ¨', 'Ïõ∞ÌîÑÎ°ú_Ï£º', 'Ïõ∞ÌîÑÎ°ú_Ïïº'].forEach(k => { const v = document.getElementById(`ov_${u}_${k}`).value; if (v) OV[sn][k] = Number(v); else delete OV[sn][k]; });["Ï°∞Ïãù", "Ï§ëÏãù", "ÏÑùÏãù", "ÏïºÏãù"].forEach(m => { ["ÌèâÏùº", "Ï£ºÎßê", "Ïã§Ìà¨ÏûÖ"].forEach(t => { const el = document.getElementById(`ov_${u}_${m}_${t}`); if (!el) return; const v = el.value; if (v) OV[sn][m + '_' + t] = Number(v); else delete OV[sn][m + '_' + t]; }); }); so(); render(); };
        window.svRec = function (u, sn, rg) { /* ÌïòÎã®ÏóêÏÑú Ïû¨Ï†ïÏùò */ };
        window.toggleGoalEdit = function (u) { const keys = ['Îß§Ï∂ú', 'Ïù¥Ïùµ', 'Ïû¨Î£å']; const hint = document.getElementById(`goal-edit-hint-${u}`); const isEditing = document.getElementById(`gi_Îß§Ï∂ú_${u}`).style.display !== 'none'; keys.forEach(k => { const inp = document.getElementById(`gi_${k}_${u}`); const val = document.getElementById(`gv_${k}_${u}`); if (inp && val) { inp.style.display = isEditing ? 'none' : 'block'; val.style.display = isEditing ? 'block' : 'none'; } }); if (hint) hint.textContent = isEditing ? 'üìù ÏàòÏπò ÌÑ∞Ïπò Ïãú ÏßÅÏ†ë ÏàòÏ†ï Í∞ÄÎä•' : '‚úÖ ÏàòÏ†ï Ï§ë ‚Äî Í∞í ÏûÖÎ†• ÌõÑ Îã§Î•∏ Í≥≥ ÌÑ∞Ïπò'; };
        window.saveGoal = function (u, sn, key, val) { OV[sn] = OV[sn] || {}; const km = { 'Îß§Ï∂ú': 'goal_Îß§Ï∂ú', 'Ïù¥Ïùµ': 'goal_Ïù¥Ïùµ', 'Ïû¨Î£å': 'goal_Ïû¨Î£å' }, cm = { 'Îß§Ï∂ú': 'var(--accent)', 'Ïù¥Ïùµ': 'var(--success)', 'Ïû¨Î£å': 'var(--warning)' }; if (val) { OV[sn][km[key]] = Number(val); const el = document.getElementById(`gv_${key}_${u}`); if (el) { el.style.color = cm[key]; el.textContent = Number(val).toLocaleString(); } } else { delete OV[sn][km[key]]; } so(); };
        window.updateIntensity = function (u, sn) { const d = D.find(x => x["ÏÇ¨ÏóÖÏû•Î™Ö"] === sn); if (!d) return; const meals = ["Ï°∞Ïãù", "Ï§ëÏãù", "ÏÑùÏãù", "ÏïºÏãù"]; let totalFood = 0, totalStaff = 0; meals.forEach(m => { const food = n(d["DI_" + m]) + n(d["TO_" + m]); totalFood += food; const el = document.getElementById(`ov_${u}_${m}_Ïã§Ìà¨ÏûÖ`); const st = el && el.value ? Number(el.value) : gMS(sn, m); totalStaff += st; }); const avg = totalStaff > 0 ? totalFood / (totalStaff / meals.length) : 0; const pct = Math.min(avg / 130 * 100, 100); const col = avg >= 95 ? "var(--danger)" : avg >= 80 ? "var(--warning)" : "var(--success)"; const ib = document.getElementById(`ib_${u}`), iv = document.getElementById(`iv_${u}`); if (ib) { ib.style.width = pct + "%"; ib.style.background = col; } if (iv) { iv.style.color = col; iv.textContent = avg.toFixed(1) + "Ïãù/Ïù∏"; } };

        /* ===== ÎàÑÏ†Å Îç∞Ïù¥ÌÑ∞ (localStorage) ===== */
        function getRec() { try { return JSON.parse(localStorage.getItem("WS_REC") || "[]") } catch (e) { return [] } }
        function saveRec(arr) { localStorage.setItem("WS_REC", JSON.stringify(arr)); }
        function addRec(rec) { const arr = getRec(); const idx = arr.findIndex(r => r.date === rec.date && r.siteName === rec.siteName); if (idx >= 0) arr[idx] = rec; else arr.push(rec); arr.sort((a, b) => a.date > b.date ? -1 : 1); saveRec(arr); }

        /* ===== Ïã§Ï†Å Í∏∞Î°ù: ÎÇ†Ïßú Î≥ÄÍ≤Ω Ïãú Í≥ºÍ±∞ Îç∞Ïù¥ÌÑ∞ Î∂àÎü¨Ïò§Í∏∞ (ÏàòÏ†ï Î™®Îìú) ===== */
        window.loadPastRec = function (u, sn, dateVal) {
            const today = new Date().toISOString().slice(0, 10);
            const modeEl = document.getElementById(`fmode_${u}`);
            const recs = getRec();
            const past = recs.find(r => r.date === dateVal && r.siteName === sn);
            if (past) {
                /* Í≥ºÍ±∞ Îç∞Ïù¥ÌÑ∞ Ï±ÑÏö∞Í∏∞ */
                ['fd1', 'fd2', 'fd3', 'fd4'].forEach((id, i) => { const el = document.getElementById(`${id}_${u}`); if (el) el.value = past[['DI_Ï°∞Ïãù', 'DI_Ï§ëÏãù', 'DI_ÏÑùÏãù', 'DI_ÏïºÏãù'][i]] || ''; });
                ['ft1', 'ft2', 'ft3', 'ft4'].forEach((id, i) => { const el = document.getElementById(`${id}_${u}`); if (el) el.value = past[['TO_Ï°∞Ïãù', 'TO_Ï§ëÏãù', 'TO_ÏÑùÏãù', 'TO_ÏïºÏãù'][i]] || ''; });
                const fsl = document.getElementById(`fsl_${u}`); if (fsl) fsl.value = past.ÎèÑÏ†ÑÎß§Ï∂ú || '';
                const fmt = document.getElementById(`fmt_${u}`); if (fmt) fmt.value = past.Ïû¨Î£åÎπÑ || '';
                const fn1 = document.getElementById(`fn1_${u}`); if (fn1) fn1.value = past.ÏãùÏÇ¨ÌäπÏù¥ÏÇ¨Ìï≠ || '';
                const fn2 = document.getElementById(`fn2_${u}`); if (fn2) fn2.value = past.Í∏∞ÌÉÄÌäπÏù¥ÏÇ¨Ìï≠ || '';
                if (modeEl) { modeEl.textContent = '‚úèÔ∏è ÏàòÏ†ï Î™®Îìú'; modeEl.style.color = 'var(--warning)'; }
            } else {
                /* Îπà Ìèº */
                ['fd1', 'fd2', 'fd3', 'fd4', 'ft1', 'ft2', 'ft3', 'ft4', 'fsl', 'fmt'].forEach(id => { const el = document.getElementById(`${id}_${u}`); if (el) el.value = ''; });
                ['fn1', 'fn2'].forEach(id => { const el = document.getElementById(`${id}_${u}`); if (el) el.value = ''; });
                if (modeEl) { modeEl.textContent = dateVal === today ? '' : 'Ïã†Í∑ú ÏûÖÎ†•'; modeEl.style.color = 'var(--success)'; }
            }
        };

        /* ===== Ïã§Ï†Å Í∏∞Î°ù Ï†ÄÏû• (Ìèº ÌÅ¥Î¶¨Ïñ¥ Ìè¨Ìï®) ===== */
        window.svRec = async function (u, sn, rg) {
            const p = {
                tk: TK,
                date: document.getElementById(`fd_${u}`).value, siteName: sn, region: rg,
                DI_Ï°∞Ïãù: Number(document.getElementById(`fd1_${u}`).value || 0), DI_Ï§ëÏãù: Number(document.getElementById(`fd2_${u}`).value || 0),
                DI_ÏÑùÏãù: Number(document.getElementById(`fd3_${u}`).value || 0), DI_ÏïºÏãù: Number(document.getElementById(`fd4_${u}`).value || 0),
                TO_Ï°∞Ïãù: Number(document.getElementById(`ft1_${u}`).value || 0), TO_Ï§ëÏãù: Number(document.getElementById(`ft2_${u}`).value || 0),
                TO_ÏÑùÏãù: Number(document.getElementById(`ft3_${u}`).value || 0), TO_ÏïºÏãù: Number(document.getElementById(`ft4_${u}`).value || 0),
                ÎèÑÏ†ÑÎß§Ï∂ú: Number(document.getElementById(`fsl_${u}`).value || 0), Ïû¨Î£åÎπÑ: Number(document.getElementById(`fmt_${u}`).value || 0),
                ÏãùÏÇ¨ÌäπÏù¥ÏÇ¨Ìï≠: document.getElementById(`fn1_${u}`).value || "", Í∏∞ÌÉÄÌäπÏù¥ÏÇ¨Ìï≠: document.getElementById(`fn2_${u}`).value || ""
            };
            addRec(p);
            const btn = event.target, msg = document.getElementById(`fm_${u}`);
            btn.disabled = true; btn.innerText = "Ï†ÄÏû• Ï§ë...";
            try {
                const r = await fetch(API, { method: "POST", body: JSON.stringify(p) });
                const t = await r.text();
                msg.style.color = t.includes("Success") ? "var(--success)" : "var(--danger)";
                msg.innerText = t.includes("Success") ? "‚úÖ Ï†ÄÏû• ÏôÑÎ£å" : "‚ùå " + t;
            } catch (e) { msg.style.color = "var(--warning)"; msg.innerText = "‚ö†Ô∏è ÏÑúÎ≤Ñ Ïò§Î•ò (Î°úÏª¨ Ï†ÄÏû• ÏôÑÎ£å)"; }
            finally { btn.disabled = false; btn.innerText = "üíæ Ï†ÄÏû•"; }
            /* ‚ë£ ÌÅ¥Î¶∞ Î™®Îìú: Ï†ÄÏû• ÏÑ±Í≥µ Ïãú Ìèº Ï¥àÍ∏∞Ìôî */
            const msgEl = document.getElementById(`fm_${u}`);
            if (msgEl && msgEl.innerText.startsWith("‚úÖ")) {
                setTimeout(() => {
                    ['fd1', 'fd2', 'fd3', 'fd4', 'ft1', 'ft2', 'ft3', 'ft4', 'fsl', 'fmt'].forEach(id => { const el = document.getElementById(`${id}_${u}`); if (el) el.value = ''; });
                    ['fn1', 'fn2'].forEach(id => { const el = document.getElementById(`${id}_${u}`); if (el) el.value = ''; });
                    /* ÎÇ†ÏßúÎ•º Ïò§ÎäòÎ°ú Î¶¨ÏÖã */
                    const fdEl = document.getElementById(`fd_${u}`); if (fdEl) fdEl.value = new Date().toISOString().slice(0, 10);
                    const modeEl = document.getElementById(`fmode_${u}`); if (modeEl) modeEl.textContent = '';
                    if (msgEl) msgEl.innerText = '';
                }, 2000);
            }
        };

        /* ===== Ï∫òÎ¶∞Îçî ===== */
        let calYear = new Date().getFullYear(), calMonth = new Date().getMonth(), calSel = null;
        window.openCal = function () { populateSiteSel(); renderCal(); document.getElementById("cal-modal").classList.add("show"); };
        window.openCalForSite = function (sn) { populateSiteSel(); document.getElementById("cal-site-sel").value = sn; renderCal(); document.getElementById("cal-modal").classList.add("show"); };
        function populateSiteSel() { const sel = document.getElementById("cal-site-sel"); const sites = [...new Set(D.map(d => d["ÏÇ¨ÏóÖÏû•Î™Ö"]).filter(Boolean))]; sel.innerHTML = '<option value="ALL">Ï†ÑÏ≤¥ ÏÇ¨ÏóÖÏû•</option>' + sites.map(s => `<option value="${s}">${s}</option>`).join(""); }
        window.renderCal = function () { const lbl = document.getElementById("cal-month-lbl"); lbl.textContent = `${calYear}ÎÖÑ ${calMonth + 1}Ïõî`; const recs = getRec(); const siteSel = document.getElementById("cal-site-sel").value; const filtered = recs.filter(r => siteSel === "ALL" || r.siteName === siteSel); const dateDates = new Set(filtered.map(r => r.date)); const first = new Date(calYear, calMonth, 1), last = new Date(calYear, calMonth + 1, 0), today = new Date().toISOString().slice(0, 10); let html = ['Ïùº', 'Ïõî', 'Ìôî', 'Ïàò', 'Î™©', 'Í∏à', 'ÌÜ†'].map(d => `<div class="cal-dow">${d}</div>`).join(""); const startDow = first.getDay(), prevLast = new Date(calYear, calMonth, 0).getDate(); for (let i = startDow - 1; i >= 0; i--)html += `<div class="cal-day other-month" style="cursor:default">${prevLast - i}</div>`; for (let d = 1; d <= last.getDate(); d++) { const ds = `${calYear}-${String(calMonth + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`, hasData = dateDates.has(ds), isTod = ds === today, isSel = ds === calSel; html += `<div class="cal-day ${hasData ? 'has-data' : ''} ${isTod ? 'today' : ''} ${isSel ? 'selected' : ''}" onclick="selectCalDay('${ds}')">${d}</div>`; } const remaining = 42 - startDow - last.getDate(); for (let i = 1; i <= remaining; i++)html += `<div class="cal-day other-month" style="cursor:default">${i}</div>`; document.getElementById("cal-days").innerHTML = html; if (calSel) showCalDetail(calSel, filtered); };
        window.calPrev = function () { calMonth--; if (calMonth < 0) { calMonth = 11; calYear--; } renderCal(); };
        window.calNext = function () { calMonth++; if (calMonth > 11) { calMonth = 0; calYear++; } renderCal(); };
        window.selectCalDay = function (ds) { calSel = ds; const siteSel = document.getElementById("cal-site-sel").value; const recs = getRec().filter(r => r.date === ds && (siteSel === "ALL" || r.siteName === siteSel)); renderCal(); showCalDetail(ds, recs.length ? recs : getRec().filter(r => r.date === ds)); };
        function showCalDetail(ds, recs) { const dayRecs = recs.filter ? recs.filter(r => r.date === ds) : []; const det = document.getElementById("cal-detail"); const siteSel = document.getElementById("cal-site-sel").value; const activeSites = siteSel === "ALL" ? [...new Set(D.map(d => d["ÏÇ¨ÏóÖÏû•Î™Ö"]).filter(Boolean))] : [siteSel]; let h = `<div class="cal-detail"><div class="dt-title">üìÖ ${ds} ÏãùÏàò ÌòÑÌô©</div>`; activeSites.forEach(site => { const rec = dayRecs.find(r => r.siteName === site); const di_jo = rec ? rec.DI_Ï°∞Ïãù : 0, di_ju = rec ? rec.DI_Ï§ëÏãù : 0, di_sk = rec ? rec.DI_ÏÑùÏãù : 0, di_ya = rec ? rec.DI_ÏïºÏãù : 0, to_jo = rec ? rec.TO_Ï°∞Ïãù : 0, to_ju = rec ? rec.TO_Ï§ëÏãù : 0, to_sk = rec ? rec.TO_ÏÑùÏãù : 0, to_ya = rec ? rec.TO_ÏïºÏãù : 0; const totalDI = di_jo + di_ju + di_sk + di_ya, totalTO = to_jo + to_ju + to_sk + to_ya, hasData = !!rec; const statusTag = hasData ? `<span style="font-size:9px;padding:2px 6px;border-radius:4px;background:rgba(52,211,153,.1);color:var(--success);font-weight:800">‚óè Í∏∞Î°ùÎê®</span>` : `<span style="font-size:9px;padding:2px 6px;border-radius:4px;background:rgba(100,116,139,.1);color:var(--dim);font-weight:800">‚óã ÎØ∏Í∏∞Î°ù</span>`; h += `<div style="margin-bottom:12px;padding:10px;background:rgba(0,0,0,.2);border-radius:10px"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><div style="font-size:12px;font-weight:900;color:var(--accent)">üè¢ ${site}</div><button onclick="jumpToPerf('${site}','${ds}');event.stopPropagation();" style="background:rgba(255,255,255,.06);border:1px solid var(--border);color:#fff;padding:4px 8px;border-radius:8px;font-size:11px;cursor:pointer;">‚úèÔ∏è ÏàòÏ†ï</button>${statusTag}</div><div class="cal-meal-grid"><div class="cal-meal-box"><div class="mlb">Ï°∞Ïãù</div><div class="mval" style="${!hasData ? 'opacity:.35' : ''}">${(di_jo + to_jo) || '-'}</div><div class="msub">D/I:${di_jo} T/O:${to_jo}</div></div><div class="cal-meal-box"><div class="mlb">Ï§ëÏãù</div><div class="mval" style="color:var(--accent);${!hasData ? 'opacity:.35' : ''}">${(di_ju + to_ju) || '-'}</div><div class="msub">D/I:${di_ju} T/O:${to_ju}</div></div><div class="cal-meal-box"><div class="mlb">ÏÑùÏãù</div><div class="mval" style="${!hasData ? 'opacity:.35' : ''}">${(di_sk + to_sk) || '-'}</div><div class="msub">D/I:${di_sk} T/O:${to_sk}</div></div><div class="cal-meal-box"><div class="mlb">ÏïºÏãù</div><div class="mval" style="${!hasData ? 'opacity:.35' : ''}">${(di_ya + to_ya) || '-'}</div><div class="msub">D/I:${di_ya} T/O:${to_ya}</div></div></div><div style="display:flex;gap:8px;font-size:11px;padding:8px;background:rgba(0,0,0,.2);border-radius:8px;margin-top:4px;flex-wrap:wrap"><span>Ï¥ù D/I: <strong style="color:var(--accent)">${totalDI || '-'}</strong></span><span>Ï¥ù T/O: <strong style="color:var(--warning)">${totalTO || '-'}</strong></span><span>Ìï©Í≥Ñ: <strong style="color:${hasData ? 'var(--success)' : 'var(--dim)'}">${(totalDI + totalTO) || '-'}</strong></span>${rec && rec.ÎèÑÏ†ÑÎß§Ï∂ú > 0 ? `<span>Îß§Ï∂ú: <strong>${Number(rec.ÎèÑÏ†ÑÎß§Ï∂ú).toLocaleString()}Ïõê</strong></span>` : ''}</div>${rec && (rec.ÏãùÏÇ¨ÌäπÏù¥ÏÇ¨Ìï≠ || rec.Í∏∞ÌÉÄÌäπÏù¥ÏÇ¨Ìï≠) ? `<div style="font-size:10px;color:var(--dim);margin-top:6px;padding:6px 8px;background:rgba(255,255,255,.02);border-radius:6px">${rec.ÏãùÏÇ¨ÌäπÏù¥ÏÇ¨Ìï≠ ? `üìù ${rec.ÏãùÏÇ¨ÌäπÏù¥ÏÇ¨Ìï≠}` : ''}${(rec.ÏãùÏÇ¨ÌäπÏù¥ÏÇ¨Ìï≠ && rec.Í∏∞ÌÉÄÌäπÏù¥ÏÇ¨Ìï≠) ? '<br>' : ''}${rec.Í∏∞ÌÉÄÌäπÏù¥ÏÇ¨Ìï≠ ? `üìå ${rec.Í∏∞ÌÉÄÌäπÏù¥ÏÇ¨Ìï≠}` : ''}</div>` : ''}</div>`; }); h += '</div>'; det.innerHTML = h; }

        /* Îç∞ÏùºÎ¶¨ Ï∫òÎ¶∞Îçî ‚Üí Ìï¥Îãπ ÏÇ¨ÏóÖÏû•/ÎÇ†Ïßú Ïã§Ï†ÅÍ∏∞Î°ùÏúºÎ°ú Ï†êÌîÑ(ÏàòÏ†ï/ÏûÖÎ†•) */
        window.jumpToPerf = function (siteName, dateStr) {
            try { closeCal(); } catch (e) { }
            const meta = D.find(x => x["ÏÇ¨ÏóÖÏû•Î™Ö"] === siteName);
            if (meta && typeof setR === "function" && meta["ÏßÄÏó≠"]) {
                // ÏßÄÏó≠Ïπ©/ÌïÑÌÑ∞Í∞Ä ÏûàÎäî Í≤ΩÏö∞ Ìï¥Îãπ ÏßÄÏó≠ÏúºÎ°ú Ïù¥Îèô
                if (typeof REG !== "undefined" && REG !== meta["ÏßÄÏó≠"]) {
                    setR(meta["ÏßÄÏó≠"]);
                }
            }
            // Î†åÎçî ÏôÑÎ£å ÌõÑ DOM ÌÉêÏÉâ
            setTimeout(() => {
                const els = Array.from(document.querySelectorAll(".site-name"));
                const hit = els.find(e => (e.textContent || "").trim().startsWith(siteName));
                if (!hit) return;
                const card = hit.closest(".card");
                if (!card) return;

                const dateInput = card.querySelector('input[type="date"][id^="fd_"]');
                if (!dateInput) return;
                const u = dateInput.id.slice(3); // fd_${u}

                // Ìå®ÎÑê Ïò§Ìîà + Í∞í ÏÑ∏ÌåÖ + Í≥ºÍ±∞ Î°úÎìú
                try { tp(u, "perf"); } catch (e) { }
                dateInput.value = dateStr;
                try { loadPastRec(u, siteName, dateStr); } catch (e) { }

                card.scrollIntoView({ behavior: "smooth", block: "start" });
                card.classList.add("flash");
                setTimeout(() => card.classList.remove("flash"), 1200);
            }, 80);
        };


        /* =====================================================
           ‚òÖ GAS Ïã§Ï†Å Îç∞Ïù¥ÌÑ∞ Î°úÎìú (Ï∂îÏù¥ Î¶¨Ìè¨Ìä∏ Ï†ÑÏö©)
           - GASÏóêÏÑú ÏÑúÎ≤Ñ Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏ÏôÄ localStorageÏóê Î®∏ÏßÄ
           - Ïù¥ÌõÑ Î¶¨Ìè¨Ìä∏Îäî Î®∏ÏßÄÎêú localStorageÎ•º Í∏∞Î∞òÏúºÎ°ú Î†åÎçîÎßÅ
        ===================================================== */
        async function loadPerfFromGAS() {
            if (_gasPerfLoading) return; // Ï§ëÎ≥µ Ìò∏Ï∂ú Î∞©ÏßÄ
            if (_gasPerfLoaded && _gasPerfCache) return; // Ïù¥ÎØ∏ Î°úÎìúÎê®
            if (!TK) { return; } // ÌÜ†ÌÅ∞ ÏóÜÏúºÎ©¥ Ïä§ÌÇµ
            _gasPerfLoading = true;
            try {
                const r = await fetch(API + "?type=perf&tk=" + TK);
                const d = await r.json();
                if (d.perf && Array.isArray(d.perf) && d.perf.length > 0) {
                    _gasPerfCache = d.perf;
                    /* localStorageÏóê Î®∏ÏßÄ (GAS Îç∞Ïù¥ÌÑ∞Í∞Ä Ïö∞ÏÑ† ‚Äî ÎèôÏùº date+siteNameÏùÄ GASÍ∞íÏúºÎ°ú ÎçÆÏñ¥Ïì∞Í∏∞) */
                    let localRecs = getRec();
                    d.perf.forEach(gasRec => {
                        const idx = localRecs.findIndex(r => r.date === gasRec.date && r.siteName === gasRec.siteName);
                        if (idx >= 0) localRecs[idx] = { ...localRecs[idx], ...gasRec }; // GAS Îç∞Ïù¥ÌÑ∞ Ïö∞ÏÑ†
                        else localRecs.push(gasRec);
                    });
                    localRecs.sort((a, b) => a.date > b.date ? -1 : 1);
                    saveRec(localRecs);
                    _gasPerfLoaded = true;
                } else if (d.error) {
                    console.warn("GAS perf error:", d.error);
                }
            } catch (e) {
                console.warn("GAS Ïã§Ï†Å Î°úÎìú Ïã§Ìå®, localStorage ÏÇ¨Ïö©:", e.message);
            } finally {
                _gasPerfLoading = false;
            }
        }

        /* ===== Ï∂îÏù¥ Î∂ÑÏÑù Î¶¨Ìè¨Ìä∏ ===== */
        window.openTrendReport = async function () {
            /* Î™®Îã¨ Î®ºÏ†Ä Ïó¥Í≥† Î°úÎî© ÌëúÏãú */
            document.getElementById("trend-modal").classList.add("show");
            const body = document.getElementById("trend-body");
            if (!_gasPerfLoaded) {
                body.innerHTML = `<div style="text-align:center;padding:60px 20px">
            <div style="font-size:32px;margin-bottom:16px">üì°</div>
            <div style="font-weight:900;margin-bottom:8px">ÏÑúÎ≤Ñ Îç∞Ïù¥ÌÑ∞ ÎèôÍ∏∞Ìôî Ï§ë...</div>
            <div style="font-size:12px;color:var(--dim)">GASÏóêÏÑú ÎàÑÏ†Å Ïã§Ï†Å Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Í≥† ÏûàÏäµÎãàÎã§</div>
        </div>`;
            }

            /* GASÏóêÏÑú Ïã§Ï†Å Îç∞Ïù¥ÌÑ∞ Î°úÎìú (ÏµúÏ¥à 1Ìöå) */
            await loadPerfFromGAS();

            /* ÏßÄÏó≠ ÎìúÎ°≠Îã§Ïö¥ Ï¥àÍ∏∞Ìôî */
            const regSel = document.getElementById("trend-region-sel");
            if (regSel) {
                const regions = [...new Set(D.map(d => d["ÏßÄÏó≠"]).filter(Boolean))];
                const cur = regSel.value;
                regSel.innerHTML = '<option value="ALL">Ï†ÑÏ≤¥ ÏßÄÏó≠</option>' + regions.map(r => `<option value="${r}">${r}</option>`).join("");
                if (regions.includes(cur)) regSel.value = cur;
                try {
                    if ((!cur || cur === "ALL") && typeof REG !== "undefined" && REG && REG !== "ALL" && regions.includes(REG)) {
                        regSel.value = REG;
                    }
                } catch (e) { }
            }
            renderTrendReport();
        };

        /* Î¶¨ÌîÑÎ†àÏãú Î≤ÑÌäº: Í∞ïÏ†ú Ïû¨ÎèôÍ∏∞Ìôî */
        window.refreshTrendFromGAS = async function () {
            _gasPerfLoaded = false; _gasPerfCache = null;
            const body = document.getElementById("trend-body");
            body.innerHTML = `<div style="text-align:center;padding:60px">üì° Ïû¨ÎèôÍ∏∞Ìôî Ï§ë...</div>`;
            await loadPerfFromGAS();
            renderTrendReport();
        };
        window.closeTrend = function () { document.getElementById("trend-modal").classList.remove("show"); };
        function renderTrendReport() {
            const recs = getRec(); const body = document.getElementById("trend-body");
            /* ‚ë† ÏÑ†ÌÉù ÏßÄÏó≠ ÌïÑÌÑ∞ */
            const regSel = document.getElementById("trend-region-sel");
            const selRegion = regSel ? regSel.value : "ALL";
            /* ÏßÄÏó≠Ïóê ÏÜçÌïú ÏÇ¨ÏóÖÏû•Î™Ö Ï∂îÏ∂ú */
            const regionSites = selRegion === "ALL" ? null : new Set(D.filter(d => d["ÏßÄÏó≠"] === selRegion).map(d => d["ÏÇ¨ÏóÖÏû•Î™Ö"]));
            const filteredRecs = selRegion === "ALL" ? recs : recs.filter(r => regionSites && regionSites.has(r.siteName));
            const recsToUse = filteredRecs;
            /* ÏßÄÏó≠ ÎùºÎ≤® ÌëúÏãú */
            const regionLabel = selRegion === "ALL" ? "Ï†ÑÏ≤¥ ÏßÄÏó≠" : selRegion;
            if (!recsToUse.length) { body.innerHTML = `<div class="no-data-msg"><div style="font-size:48px;margin-bottom:16px">üì≠</div><div style="font-size:15px;font-weight:900;margin-bottom:8px">ÎàÑÏ†Å Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå</div><div style="font-size:12px;color:var(--dim)">${regionLabel} ¬∑ Ïã§Ï†Å Í∏∞Î°ù ÌõÑ Î∂ÑÏÑù Î¶¨Ìè¨Ìä∏Î•º ÌôïÏù∏Ìï† Ïàò ÏûàÏäµÎãàÎã§</div></div>`; return; }
            const dates = [...new Set(recsToUse.map(r => r.date))].sort();
            document.getElementById("trend-date-range").textContent = `[${regionLabel}] ${dates[0]} ~ ${dates[dates.length - 1]} ¬∑ Ï¥ù ${dates.length}Ïùº ¬∑ ${recsToUse.length}Í±¥`;
            const sites = [...new Set(recsToUse.map(r => r.siteName))];

            // üîπ ÏãùÏàò ÎπÑÏú® ÏûêÎèô ÌïôÏäµ (ÏµúÍ∑º 14Ïùº Ïã§Ï†Å Í∏∞Î∞ò)
            let totalDI_all = 0, totalTO_all = 0, totalMidRatio_all = 0, totalJo_all = 0, countJo_all = 0;
            recsToUse.slice(0, 14).forEach(r => {
                const d = n(r.DI_Ï§ëÏãù), t = n(r.TO_Ï§ëÏãù), j = n(r.DI_Ï°∞Ïãù) + n(r.TO_Ï°∞Ïãù);
                if (d + t > 0) { totalDI_all += d; totalTO_all += t; totalMidRatio_all += (d + t); }
                if (j > 0) { totalJo_all += j; countJo_all++; }
            });
            const r_TO = totalMidRatio_all > 0 ? totalTO_all / totalMidRatio_all : 0.35;
            const r_Jo = (totalMidRatio_all > 0 && totalJo_all > 0) ? (totalJo_all / countJo_all) / (totalMidRatio_all / 14) : 0.15;

            let html = ''; const totalByDate = {};
            recsToUse.forEach(r => { if (!totalByDate[r.date]) totalByDate[r.date] = 0; totalByDate[r.date] += r.DI_Ï§ëÏãù + r.TO_Ï§ëÏãù; });
            const dailyVals = Object.values(totalByDate); const avgDaily = dailyVals.reduce((a, b) => a + b, 0) / dailyVals.length; const maxDaily = Math.max(...dailyVals); const recentDates = dates.slice(-7); const recentAvg = recentDates.reduce((a, d) => a + (totalByDate[d] || 0), 0) / recentDates.length; const trend = ((recentAvg - avgDaily) / avgDaily * 100).toFixed(1); const trendClass = trend > 1 ? 'trend-up' : trend < -1 ? 'trend-down' : 'trend-flat'; const trendIcon = trend > 1 ? '‚Üë' : trend < -1 ? '‚Üì' : '‚Üí';

            html += `<div class="trend-section"><div class="trend-section-title">üìä ${regionLabel} ÏãùÏàò KPI ÏöîÏïΩ</div><div class="kpi-row"><div class="kpi-box"><div class="kl">ÏùºÌèâÍ∑† Ï§ëÏãù</div><div class="kv" style="color:var(--accent)">${Math.round(avgDaily).toLocaleString()}</div><div class="kt" style="color:var(--dim)">Ïãù</div></div><div class="kpi-box"><div class="kl">ÏµúÍ≥† Ï§ëÏãù</div><div class="kv" style="color:var(--success)">${maxDaily.toLocaleString()}</div><div class="kt" style="color:var(--dim)">Ïãù</div></div><div class="kpi-box"><div class="kl">ÏµúÍ∑º 7Ïùº Ï∂îÏù¥</div><div class="kv ${trendClass}">${recentAvg.toFixed(0)}</div><div class="kt ${trendClass}">${trendIcon} ${Math.abs(trend)}%</div></div></div>${renderSparkline(dates, totalByDate, 'Ï§ëÏãù ÏùºÎ≥Ñ Ï∂îÏù¥')}</div>`;

            // üîπ ÏãùÏàòÎ≥Ñ Ï†ïÎ∞Ä Î∂ÑÌï¥ ÏÑπÏÖò Ï∂îÍ∞Ä
            html += `<div class="trend-section">
                <div class="trend-section-title">üìä ÏãùÏàòÎ≥Ñ Ï†ïÎ∞Ä Î∂ÑÌï¥ (Ï∂îÏ†ï Ìè¨Ìï®)</div>
                <div class="kpi-row">
                    <div class="kpi-box"><div class="kl">ÏùºÌèâÍ∑† Ï°∞Ïãù</div><div class="kv">${Math.round(avgDaily * r_Jo).toLocaleString()}</div><div class="kt">Ïãù (ÎπÑÏ§ë ${Math.round(r_Jo * 100)}%)</div></div>
                    <div class="kpi-box"><div class="kl">Ï§ëÏãù ÏùºÎ∞ò(DI)</div><div class="kv" style="color:var(--accent)">${Math.round(avgDaily * (1 - r_TO)).toLocaleString()}</div><div class="kt">Ïãù (ÎπÑÏ§ë ${Math.round((1 - r_TO) * 100)}%)</div></div>
                    <div class="kpi-box"><div class="kl">Ï§ëÏãù T/O</div><div class="kv" style="color:var(--warning)">${Math.round(avgDaily * r_TO).toLocaleString()}</div><div class="kt">Ïãù (ÎπÑÏ§ë ${Math.round(r_TO * 100)}%)</div></div>
                </div>
                <div style="font-size:10px;color:var(--dim);text-align:right;margin-top:4px">‚Äª ÏµúÍ∑º ÎàÑÏ†Å Ïã§Ï†Å Ìå®ÌÑ¥ Í∏∞Î∞ò ÏûêÎèô Ï∂îÏ†ï</div>
            </div>`;

            html += `<div class="trend-section"><div class="trend-section-title">üè¢ ÏÇ¨ÏóÖÏû•Î≥Ñ Ï∂îÏù¥ Î∂ÑÏÑù</div>`; sites.forEach(site => { const siteRecs = recsToUse.filter(r => r.siteName === site); const siteByDate = {}; siteRecs.forEach(r => { siteByDate[r.date] = (r.DI_Ï§ëÏãù || 0) + (r.TO_Ï§ëÏãù || 0); }); const siteVals = Object.values(siteByDate); if (!siteVals.length) return; const avg = siteVals.reduce((a, b) => a + b, 0) / siteVals.length; const rec7 = dates.slice(-7).reduce((a, d) => a + (siteByDate[d] || 0), 0) / 7; const t = ((rec7 - avg) / avg * 100).toFixed(1); const tc = t > 1 ? 'trend-up' : t < -1 ? 'trend-down' : 'trend-flat'; html += `<div style="margin-bottom:12px;padding:10px;background:rgba(0,0,0,.2);border-radius:8px"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><div style="font-size:12px;font-weight:900;color:var(--accent)">${site}</div><div style="display:flex;gap:8px;font-size:11px"><span>ÌèâÍ∑†: <strong>${Math.round(avg)}</strong>Ïãù</span><span class="${tc}">${t > 1 ? '‚Üë' : t < -1 ? '‚Üì' : '‚Üí'} ${Math.abs(t)}%</span></div></div>${renderSparkline(dates, siteByDate, null, 60)}</div>`; }); html += '</div>'; html += `<div class="trend-section"><div class="trend-section-title">üìâ ÏãùÏàò Ï¶ùÍ∞êÎ•† Ï£ºÍ∞Ñ ÎπÑÍµê</div><div class="tbl-wrap"><table class="data-table-mini"><thead><tr><th>ÏÇ¨ÏóÖÏû•</th>${dates.slice(-5).map(d => `<th>${d.slice(5)}</th>`).join('')}<th>Ï∂îÏÑ∏</th></tr></thead><tbody>`; sites.forEach(site => { const sr = recsToUse.filter(r => r.siteName === site); const sbd = {}; sr.forEach(r => { sbd[r.date] = (r.DI_Ï§ëÏãù || 0) + (r.TO_Ï§ëÏãù || 0); }); html += `<tr><td>${site}</td>${dates.slice(-5).map((d, i, arr) => { const v = sbd[d] || 0, prev = i > 0 ? (sbd[arr[i - 1]] || 0) : 0, ch = prev > 0 ? ((v - prev) / prev * 100).toFixed(1) : 0, c = ch > 2 ? 'trend-up' : ch < -2 ? 'trend-down' : 'trend-flat'; return `<td>${v ? v.toLocaleString() : '-'}<br><span class="${c}" style="font-size:9px">${prev > 0 ? (ch > 0 ? '+' : '') + ch + '%' : ''}</span></td>`; }).join('')}<td class="${((sbd[dates[dates.length - 1]] || 0) - (sbd[dates[dates.length - 2]] || 0)) > 0 ? 'trend-up' : 'trend-down'}" style="font-size:13px">${((sbd[dates[dates.length - 1]] || 0) - (sbd[dates[dates.length - 2]] || 0)) > 0 ? '‚Üë' : '‚Üì'}</td></tr>`; }); html += '</tbody></table></div></div>'; html += `<div class="trend-section"><div class="trend-section-title">üîÆ AI Ï∂îÏ†ï Î∂ÑÏÑù (Ìñ•ÌõÑ 7Ïùº)</div><div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;flex-wrap:wrap"><span class="forecast-tag">üìê ÏÑ†ÌòïÌöåÍ∑Ä Í∏∞Î∞ò Ï∂îÏ†ï</span><select id="ai-site-sel" onchange="renderAIForecast()" style="background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:8px;padding:5px 10px;color:var(--text);font-size:12px;font-weight:700;outline:none"><option value="ALL">Ï†ÑÏ≤¥ Ìï©ÏÇ∞</option>${sites.map(s => `<option value="${s}">${s}</option>`).join('')}</select></div><div id="ai-forecast-body"></div></div>`;
            body.innerHTML = html;
            window._aiTrendDates = dates; window._aiTrendRecs = recsToUse; window._aiTrendSites = sites; window._aiTrendAvgDaily = avgDaily;
            renderAIForecast();
        }
        window.renderAIForecast = function () {
            const sel = document.getElementById("ai-site-sel"); if (!sel) return;
            const selSite = sel.value;
            const dates = window._aiTrendDates || []; const recsToUse = window._aiTrendRecs || []; const avgDaily = window._aiTrendAvgDaily || 0;
            const container = document.getElementById("ai-forecast-body"); if (!container) return;
            const targetRecs = selSite === "ALL" ? recsToUse : recsToUse.filter(r => r.siteName === selSite);
            const byDate = {}; targetRecs.forEach(r => { if (!byDate[r.date]) byDate[r.date] = 0; byDate[r.date] += (r.DI_Ï§ëÏãù || 0) + (r.TO_Ï§ëÏãù || 0); });
            const vals = Object.values(byDate);
            const baseAvg = vals.length ? vals.reduce((a, b) => a + b, 0) / vals.length : avgDaily;
            const allDates = [...new Set(targetRecs.map(r => r.date))].sort();
            let html2 = '';
            if (vals.length >= 3) {
                const nn = vals.length, xs = vals.map((_, i) => i), ys = vals;
                const xm = xs.reduce((a, b) => a + b, 0) / nn, ym = ys.reduce((a, b) => a + b, 0) / nn;
                const slope = xs.reduce((a, x, i) => a + (x - xm) * (ys[i] - ym), 0) / xs.reduce((a, x) => a + (x - xm) ** 2, 0);
                const intercept = ym - slope * xm;
                const forecasts = [1, 2, 3, 4, 5, 6, 7].map(d => ({ d, val: Math.max(0, Math.round(intercept + slope * (nn + d - 1))) }));
                const lastDate = allDates.length ? new Date(allDates[allDates.length - 1]) : new Date();
                html2 += '<div class="tbl-wrap"><table class="data-table-mini"><thead><tr><th>ÏòàÏ∏°Ïùº</th><th>Ï∂îÏ†ï Ï§ëÏãù</th><th>Î≥ÄÌôî</th></tr></thead><tbody>';
                forecasts.forEach(({ d, val }) => {
                    const fd2 = new Date(lastDate); fd2.setDate(fd2.getDate() + d); const ds2 = fd2.toISOString().slice(0, 10);
                    const dayInfo = getHolidayType(ds2);
                    let dayTag = "";
                    let trOpacity = "1";
                    if (dayInfo.type === "sandwich") {
                        dayTag = `<span class="forecast-tag" style="background:rgba(251,191,36,.18); border-color:rgba(251,191,36,.35); color:var(--warning)">ÏßïÍ≤ÄÎã§Î¶¨</span>`;
                    } else if (dayInfo.type === "holiday" || dayInfo.type === "weekend") {
                        dayTag = `<span class="forecast-tag" style="background:rgba(248,113,113,.15); border-color:rgba(248,113,113,.25); color:var(--danger)">${dayInfo.label}</span>`;
                        trOpacity = "0.45";
                    }
                    const ch = baseAvg > 0 ? ((val - baseAvg) / baseAvg * 100).toFixed(1) : 0, c = ch > 0 ? 'trend-up' : ch < 0 ? 'trend-down' : 'trend-flat'; html2 += `<tr style="opacity:${trOpacity};"><td>${ds2.slice(5)} ${dayTag}</td><td style="color:var(--accent3);font-weight:900">${val.toLocaleString()}</td><td class="${c}">${ch > 0 ? '+' : ''}${ch}%</td></tr>`;
                });
                html2 += '</tbody></table></div>';
                const direction = slope > 2 ? 'üìà Ï¶ùÍ∞Ä Ï∂îÏÑ∏ (Ï†ÅÍ∑π ÎåÄÏùë Í∂åÏû•)' : slope < -2 ? 'üìâ Í∞êÏÜå Ï∂îÏÑ∏ (ÏõêÏù∏ Î∂ÑÏÑù ÌïÑÏöî)' : '‚û°Ô∏è ÏïàÏ†ïÏ†Å Ïú†ÏßÄ Íµ¨Í∞Ñ';
                const label = selSite === "ALL" ? "Ï†ÑÏ≤¥ Ìï©ÏÇ∞" : selSite;
                html2 += `<div style="margin-top:10px;padding:10px;background:rgba(167,139,250,.06);border:1px solid rgba(167,139,250,.15);border-radius:8px;font-size:11px;line-height:1.8"><strong style="color:var(--accent3)">Ï¢ÖÌï© ÏßÑÎã® ¬∑ ${label}</strong><br>${direction}<br><span style="color:var(--dim)">ÏùºÌèâÍ∑† Î≥ÄÌôîÏú®: ${slope > 0 ? '+' : ''}${slope.toFixed(1)}Ïãù/Ïùº ¬∑ ÏòàÏ∏° Ïã†Î¢∞ÎèÑ: ${nn >= 10 ? 'ÎÜíÏùå ‚úÖ' : nn >= 5 ? 'Ï§ëÍ∞Ñ ‚ö†Ô∏è' : 'ÎÇÆÏùå (Îç∞Ïù¥ÌÑ∞ Î∂ÄÏ°±) ‚ùå'}</span></div>`;
            } else { html2 = '<div class="no-data-msg" style="padding:16px">Ï∂îÏ†ïÏóêÎäî ÏµúÏÜå 3Ïùº Ïù¥ÏÉÅÏùò Í∏∞Î°ùÏù¥ ÌïÑÏöîÌï©ÎãàÎã§</div>'; }
            container.innerHTML = html2;
        };
        function renderSparkline(dates, byDate, label, h = 80) { const vals = dates.map(d => byDate[d] || 0).filter(v => v > 0); if (vals.length < 2) return ''; const max = Math.max(...vals), min = Math.min(...vals), w = 300, pad = 8; const pts = vals.map((v, i) => `${pad + (i / (vals.length - 1)) * (w - 2 * pad)},${pad + (1 - (v - min) / (max - min || 1)) * (h - 2 * pad)}`).join(' '); const fill = pts; return `<div class="sparkline-wrap" style="background:rgba(0,0,0,.2);border-radius:8px;padding:8px">${label ? `<div style="font-size:10px;color:var(--dim);font-weight:700;margin-bottom:6px">${label}</div>` : ''}<svg viewBox="0 0 ${w} ${h}" style="width:100%;height:${h}px;display:block"><defs><linearGradient id="sg${h}" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="var(--accent)" stop-opacity=".4"/><stop offset="100%" stop-color="var(--accent)" stop-opacity="0"/></linearGradient></defs><polyline points="${fill} ${w - pad},${h - pad} ${pad},${h - pad}" fill="url(#sg${h})" stroke="none"/><polyline points="${pts}" fill="none" stroke="var(--accent)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="${pad + (1 / (vals.length - 1 || 1)) * (w - 2 * pad) * (vals.length - 1)}" cy="${pad + (1 - (vals[vals.length - 1] - min) / (max - min || 1)) * (h - 2 * pad)}" r="4" fill="var(--accent)"/></svg><div style="display:flex;justify-content:space-between;font-size:9px;color:var(--dim);margin-top:2px"><span>min ${min.toLocaleString()}</span><span>max ${max.toLocaleString()}</span></div></div>`; }

        window.exportReport = function () { const body = document.getElementById("trend-body").innerHTML; const now = new Date().toLocaleDateString('ko-KR'); const html = `<!DOCTYPE html><html lang="ko"><head><meta charset="utf-8"><title>Welstory Î∂ÑÏÑù Î¶¨Ìè¨Ìä∏ ${now}</title><style>body{font-family:'Malgun Gothic',sans-serif;background:#0a0f1e;color:#f1f5f9;padding:24px;max-width:800px;margin:0 auto}.trend-section{background:#111827;border:1px solid rgba(148,163,184,.08);border-radius:12px;padding:18px;margin-bottom:16px}.trend-section-title{font-size:13px;font-weight:900;color:#38bdf8;margin-bottom:14px}.kpi-row{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:14px}.kpi-box{background:rgba(255,255,255,.02);border:1px solid rgba(148,163,184,.08);border-radius:10px;padding:12px;text-align:center}.kl{font-size:9px;color:#64748b;font-weight:700;margin-bottom:4px}.kv{font-size:18px;font-weight:900}.kt{font-size:10px;font-weight:700;margin-top:2px}.trend-up{color:#34d399}.trend-down{color:#f87171}.trend-flat{color:#fbbf24}.tbl-wrap{border:1px solid rgba(148,163,184,.08);border-radius:8px;overflow:hidden}table{width:100%;border-collapse:collapse;font-size:11px}th{padding:8px;text-align:center;color:#64748b;font-size:10px;font-weight:700;border-bottom:1px solid rgba(148,163,184,.08)}td{padding:8px;text-align:center;border-bottom:1px solid rgba(255,255,255,.03);font-weight:700}td:first-child{text-align:left;color:#38bdf8;font-weight:800}h1{font-size:20px;font-weight:900;color:#38bdf8;margin-bottom:6px}.sub{font-size:12px;color:#64748b;margin-bottom:24px}</style></head><body><h1>üìà Welstory Ï†ïÎ∞Ä Î∂ÑÏÑù Î¶¨Ìè¨Ìä∏</h1><div class="sub">ÏÉùÏÑ±Ïùº: ${now} ¬∑ Samsung Welstory Ïö¥ÏòÅ ÌòÑÌô© Í¥ÄÎ¶¨ÏãúÏä§ÌÖú</div>${body}</body></html>`; const blob = new Blob([html], { type: 'text/html;charset=utf-8' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `Welstory_Î¶¨Ìè¨Ìä∏_${now.replace(/\./g, '')}.html`; a.click(); };
        window.copyReportText = function () { const body = document.getElementById("trend-body"); const text = body ? body.innerText : ''; navigator.clipboard.writeText(text).then(() => alert("Î¶¨Ìè¨Ìä∏ ÌÖçÏä§Ìä∏Í∞Ä ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§.")).catch(() => { const ta = document.createElement('textarea'); ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); alert("Î≥µÏÇ¨ ÏôÑÎ£å"); }); };

        /* ===== REPORT ===== */
        window.openReport = function () {
            const fd = D.filter(d => d["ÏßÄÏó≠"] === REG);
            if (!fd.length) return;
            const ct = document.getElementById("ov-ct");
            let h = `<div class="ov-hdr"><h3>üìä ${REG} Ïö¥ÏòÅ Î¶¨Ìè¨Ìä∏</h3><button class="cls-btn" onclick="document.getElementById('ov').style.display='none'">Îã´Í∏∞</button></div>`;
            h += `<div class="sec-title">üî• ÏóÖÎ¨¥ Í∞ïÎèÑ (ÏÇ¨ÏóÖÏû• ÎπÑÍµê)</div>`;
            const intensities = fd.map(d => ({ name: d["ÏÇ¨ÏóÖÏû•Î™Ö"], it: inten(d) }));
            const svgW = 320, svgH = 140, padL = 38, padR = 12, padT = 16, padB = 32, plotW = svgW - padL - padR, plotH = svgH - padT - padB;
            const allScores = intensities.map(x => x.it.s), maxS = Math.max(...allScores, 100), minS = Math.min(0, ...allScores);
            const toX = i => padL + (i / (intensities.length - 1 || 1)) * plotW, toY = v => padT + (1 - (v - minS) / (maxS - minS)) * plotH;
            const y80 = toY(80), y95 = toY(95), pts = intensities.map((x, i) => `${toX(i)},${toY(x.it.s)}`).join(' ');
            let svgHtml = `<div style="margin-bottom:16px;overflow-x:auto"><svg viewBox="0 0 ${svgW} ${svgH}" style="width:100%;min-width:${svgW}px;height:${svgH}px;display:block"><defs><linearGradient id="ig" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#38bdf8" stop-opacity=".25"/><stop offset="100%" stop-color="#38bdf8" stop-opacity="0"/></linearGradient></defs><line x1="${padL}" y1="${y80}" x2="${svgW - padR}" y2="${y80}" stroke="#fbbf24" stroke-width="1" stroke-dasharray="4,3" opacity=".5"/><text x="${padL - 4}" y="${y80 + 4}" font-size="8" fill="#fbbf24" text-anchor="end" opacity=".7">80</text><line x1="${padL}" y1="${y95}" x2="${svgW - padR}" y2="${y95}" stroke="#f87171" stroke-width="1" stroke-dasharray="4,3" opacity=".5"/><text x="${padL - 4}" y="${y95 + 4}" font-size="8" fill="#f87171" text-anchor="end" opacity=".7">95</text><line x1="${padL}" y1="${padT + plotH}" x2="${svgW - padR}" y2="${padT + plotH}" stroke="rgba(148,163,184,.12)" stroke-width="1"/><polygon points="${intensities.map((x, i) => `${toX(i)},${toY(x.it.s)}`).join(' ')} ${toX(intensities.length - 1)},${padT + plotH} ${toX(0)},${padT + plotH}" fill="url(#ig)"/><polyline points="${pts}" fill="none" stroke="var(--accent)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>${intensities.map((x, i) => { const lb = iLb(x.it.s), cx = toX(i), cy = toY(x.it.s), nameShort = x.name.length > 4 ? x.name.slice(0, 4) + '‚Ä¶' : x.name; return `<circle cx="${cx}" cy="${cy}" r="5" fill="${lb.c}" stroke="var(--bg)" stroke-width="2"/><text x="${cx}" y="${cy - 10}" font-size="10" font-weight="900" fill="${lb.c}" text-anchor="middle">${x.it.s.toFixed(0)}</text><text x="${cx}" y="${svgH - padB + 14}" font-size="9" fill="var(--muted)" text-anchor="middle">${nameShort}</text>`; }).join('')}</svg><div style="display:flex;gap:14px;justify-content:center;font-size:9px;color:var(--dim);margin-top:4px"><span style="display:flex;align-items:center;gap:3px"><span style="width:18px;height:1px;background:#fbbf24;display:inline-block;border-top:1px dashed #fbbf24"></span>80 Ï£ºÏùòÍ∏∞Ï§Ä</span><span style="display:flex;align-items:center;gap:3px"><span style="width:18px;height:1px;background:#f87171;display:inline-block;border-top:1px dashed #f87171"></span>95 Í≥ºÎ∂ÄÌïòÍ∏∞Ï§Ä</span></div></div>`;
            svgHtml += `<div style="display:flex;flex-direction:column;gap:6px;margin-bottom:12px">`;
            intensities.forEach(({ name, it }) => {
                const lb = iLb(it.s);
                svgHtml += `<div style="display:flex;justify-content:space-between;align-items:center;padding:7px 10px;background:rgba(0,0,0,.2);border-radius:8px"><span style="font-size:12px;font-weight:900">${name}</span><div style="display:flex;gap:10px;align-items:center;font-size:11px;color:var(--dim)"><span>Ìà¨ÏûÖ ${it.st}Î™Ö</span><span>Ï¥ù ${it.tm.toLocaleString()}Ïãù</span><span class="badge" style="color:${lb.c};background:${lb.b}">${lb.e} ${lb.t} <strong style="color:${lb.c}">${it.s.toFixed(1)}</strong></span></div></div>`;
            });
            svgHtml += '</div>';
            h += svgHtml;
            const mxL = Math.max(...fd.map(d => n(d["DI_Ï§ëÏãù"]) + n(d["TO_Ï§ëÏãù"])));
            h += `<div class="sec-title">üè¢ Ï§ëÏãù ÎπÑÍµê (D/I ¬∑ T/O)</div>`;
            fd.forEach(d => {
                const di = n(d["DI_Ï§ëÏãù"]), to = n(d["TO_Ï§ëÏãù"]), tot = di + to, pDI = mxL > 0 ? (di / mxL * 100) : 0, pTO = mxL > 0 ? (to / mxL * 100) : 0;
                h += `<div style="margin-bottom:12px"><div style="display:flex;justify-content:space-between;font-size:12px;font-weight:900;margin-bottom:4px"><span>${d["ÏÇ¨ÏóÖÏû•Î™Ö"]}</span><span style="color:var(--dim);font-weight:700">Ìï©Í≥Ñ ${f(tot)}</span></div><div class="ch-dual"><div class="ch-track"><div class="ch-fill" style="width:${pDI}%;background:linear-gradient(90deg,var(--accent),var(--accent2))">${f(di)}</div></div></div><div class="ch-dual"><div class="ch-track"><div class="ch-fill" style="width:${pTO}%;background:linear-gradient(90deg,var(--warning),#f59e0b)">${f(to)}</div></div></div><div style="display:flex;gap:12px;font-size:9px;color:var(--dim);margin-top:1px"><span>üîµ D/I</span><span>üü† T/O</span></div></div>`;
            });
            h += `<div class="sec-title">üîÑ ÌöåÏ†ÑÏú® ÎπÑÍµê</div><div class="tbl-wrap"><table><thead><tr><th style="text-align:left">ÏÇ¨ÏóÖÏû•</th><th>D/I</th><th>T/OÌè¨Ìï®</th><th style="width:100px">ÎπÑÍµê</th></tr></thead><tbody>`;
            fd.forEach(d => {
                const re = n(d["ÌöåÏ†ÑÏú®(Ï§ëÏãù_T/OÏ†úÏô∏)"]), ri = n(d["ÌöåÏ†ÑÏú®(Ï§ëÏãù_T/OÌè¨Ìï®)"]);
                h += `<tr><td>${d["ÏÇ¨ÏóÖÏû•Î™Ö"]}</td><td style="color:${rc(re)};font-weight:900">${re.toFixed(1)}</td><td style="color:${rc(ri)};font-weight:900">${ri.toFixed(1)}</td><td><div style="display:flex;gap:2px;height:14px"><div style="width:${Math.min(re / 4 * 100, 100)}%;background:var(--success);border-radius:3px 0 0 3px"></div><div style="width:${Math.min((ri - re) / 4 * 100, 100)}%;background:var(--warning);border-radius:0 3px 3px 0"></div></div></td></tr>`;
            });
            h += `</tbody></table></div>`;
            h += `<div class="sec-title">üìã Ï¢ÖÌï© ÎπÑÍµê</div><div class="tbl-wrap" style="overflow-x:auto"><table style="min-width:440px"><thead><tr><th style="text-align:left">ÏÇ¨ÏóÖÏû•</th><th>Ïù∏Ïõê</th><th>Ï¢åÏÑù</th><th>Ï§ëÏãùÌï©</th><th>ÌöåÏ†ÑÏú®</th><th>Ïù∏ÏãúÎãπ</th><th>Í∞ïÎèÑ</th></tr></thead><tbody>`;
            fd.forEach(d => {
                const st = gSt(d), di = n(d["DI_Ï§ëÏãù"]), to = n(d["TO_Ï§ëÏãù"]), rot = n(d["ÌöåÏ†ÑÏú®(Ï§ëÏãù_T/OÌè¨Ìï®)"]), it = inten(d), lb = iLb(it.s), eff = st > 0 ? ((di + to) / st).toFixed(1) : "-";
                h += `<tr><td>${d["ÏÇ¨ÏóÖÏû•Î™Ö"]}</td><td>${st}</td><td>${f(gSeats(d))}</td><td>${f(di + to)}</td><td style="color:${rc(rot)}">${rot.toFixed(1)}</td><td style="color:var(--accent)">${eff}</td><td><span class="badge" style="color:${lb.c};background:${lb.b};font-size:9px">${lb.e}${it.s.toFixed(0)}</span></td></tr>`;
            });
            h += `</tbody></table></div>`;

            /* ÏÉÅÌô© ÏßÑÎã® Í∞ÄÏù¥Îìú Ï∂îÍ∞Ä */
            h += `<div class="sec-title">üí° Ïö¥ÏòÅ ÏÉÅÌô© ÏßÑÎã® Î∞è ÏÜîÎ£®ÏÖò Í∞ÄÏù¥Îìú (Updated)</div>
            <div style="padding:14px;background:rgba(56,189,248,.04);border:1px solid rgba(56,189,248,.12);border-radius:12px;font-size:11px;line-height:1.7">
                <div style="margin-bottom:10px">
                    <strong style="color:var(--warning)">CASE A. ÌöåÏ†ÑÏú®ÏùÄ ÎÜíÏúºÎÇò ÏóÖÎ¨¥ Í∞ïÎèÑ Î≥¥ÌÜµ (üü°/üü¢)</strong><br>
                    ‚Ä¢ <span style="color:var(--text)">ÏßÑÎã®:</span> Ï°∞Î¶¨ Ïù∏Î†•ÏùÄ Ï†ÅÏ†ïÌïòÎÇò **ÏãùÎãπ Í≥µÍ∞Ñ/Ï¢åÏÑùÏù¥ Î∂ÄÏ°±**Ìïú ÏÉÅÌÉúÏûÖÎãàÎã§.<br>
                    ‚Ä¢ <span style="color:var(--accent)">ÏÜîÎ£®ÏÖò:</span> Ïù∏Ïõê Ï∂©ÏõêÎ≥¥Îã§Îäî **T/O(ÎèÑÏãúÎùΩ ÌòïÌÉú) ÎπÑÏú®ÏùÑ ÌôïÎåÄ** Í∂åÏû•Ìï©ÎãàÎã§.
                </div>
                <div style="margin-bottom:10px">
                    <strong style="color:var(--danger)">CASE B. ÌöåÏ†ÑÏú®ÎèÑ ÎÜíÍ≥† ÏóÖÎ¨¥ Í∞ïÎèÑÎèÑ ÎÜíÏùå (üî¥)</strong><br>
                    ‚Ä¢ <span style="color:var(--text)">ÏßÑÎã®:</span> Í≥µÍ∞ÑÎèÑ Î∂ÄÏ°±ÌïòÍ≥† **Ï£ºÎ∞© ÏùºÏÜêÎèÑ ÌïúÍ≥ÑÏπò**Ïóê ÎèÑÎã¨Ìïú ÏúÑÌóò ÏÉÅÌÉúÏûÖÎãàÎã§.<br>
                    ‚Ä¢ <span style="color:var(--accent)">ÏÜîÎ£®ÏÖò:</span> **Ïã†Í∑ú Ïù∏Ïõê Ï∂©Ïõê**, **ÏßÄÏõê Ïù∏Î†• Ìà¨ÏûÖ** ÎòêÎäî **Ï†úÍ≥µ ÌíàÎ™©Ïàò(Î∞òÏ∞¨ Îì±) Ï∂ïÏÜå**Í∞Ä ÏãúÍ∏âÌûà ÌïÑÏöîÌï©ÎãàÎã§.
                </div>
                <div>
                    <strong style="color:var(--primary)">CASE C. T/O ÏΩîÎÑàÎãπ Ï≤òÎ¶¨Îüâ Í≥ºÎã§ (Î∂ÑÏÑùÏö©)</strong><br>
                    ‚Ä¢ <span style="color:var(--text)">ÏßÑÎã®:</span> T/O ÏΩîÎÑàÎãπ Î∞∞ÏãùÎüâÏù¥ ÌïúÍ≥ÑÏπòÎ•º Ï¥àÍ≥ºÌïòÏó¨ **ÎåÄÍ∏∞ ÎèôÏÑ† ÏßÄÏó∞**Ïù¥ Ïö∞Î†§Îê©ÎãàÎã§.<br>
                    ‚Ä¢ <span style="color:var(--accent)">ÏÜîÎ£®ÏÖò:</span> T/O Ï†úÍ≥µ ÌíàÎ™© Îã®ÏàúÌôî ÎòêÎäî Î¨¥Ïù∏ Î∞∞ÏãùÎåÄ(ÏÖÄÌîÑ ÏΩîÎÑà) Ï∂îÍ∞Ä Î∞∞Ïπò Í≤ÄÌÜ†.
                </div>
            </div>`;

            h += `<div class="note-box"><strong>üìù ÏÇ∞Ï∂ú Í∏∞Ï§Ä Î∞è Ìï¥ÏÑù</strong><br/><br/>
            <strong>‚Ä¢ ÏóÖÎ¨¥ Í∞ïÎèÑ</strong> = ÏùºÏùº Ï¥ùÏãùÏàò √∑ Ï¥ù Ìà¨ÏûÖÏù∏Ïõê<br/>
            <span class="formula">‚Üí üü¢ 80ÎØ∏Îßå ÏñëÌò∏ ¬∑ üü° 95ÎØ∏Îßå Ï£ºÏùò ¬∑ üî¥ 95Ïù¥ÏÉÅ Í≥ºÎ∂ÄÌïò(ÏòµÏÖò: ÌíàÎ™©Ïàò Ï∂ïÏÜå Í≤ÄÌÜ†)</span><br/><br/>
            <strong>‚Ä¢ ÌöåÏ†ÑÏú®(RI)</strong> = (Ï§ëÏãù D/I ÏãùÏàò + Ìï†Ïù∏Îêú TOÏãùÏàò) √∑ Ï¢åÏÑùÏàò<br/>
            <span class="formula">‚Üí üî¥ 3.5Ìöå Ïù¥ÏÉÅ: Í≥µÍ∞Ñ Í≥ºÎ∂ÄÌïò (T/O ÌôïÎåÄ ÏßëÏ§ë)</span></div>`;

            ct.innerHTML = h;
            document.getElementById("ov").style.display = "flex";
        };

        /* ===== ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤Ω ===== */
        window.openPwChange = function () {
            const modal = document.getElementById("pw-modal");
            document.getElementById("pw-cur").value = "";
            document.getElementById("pw-new").value = "";
            document.getElementById("pw-confirm").value = "";
            document.getElementById("pw-msg").textContent = "";
            modal.style.display = "flex";
            setTimeout(() => document.getElementById("pw-cur").focus(), 100);
        };
        window.submitPwChange = async function () {
            const msg = document.getElementById("pw-msg");
            const cur = document.getElementById("pw-cur").value;
            const nw = document.getElementById("pw-new").value;
            const conf = document.getElementById("pw-confirm").value;
            if (!cur) { msg.style.color = "var(--danger)"; msg.textContent = "ÌòÑÏû¨ ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî."; return; }
            if (!nw || nw.length < 4) { msg.style.color = "var(--danger)"; msg.textContent = "ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏Îäî 4Ïûê Ïù¥ÏÉÅÏù¥Ïñ¥Ïïº Ìï©ÎãàÎã§."; return; }
            if (nw !== conf) { msg.style.color = "var(--danger)"; msg.textContent = "ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÏùºÏπòÌïòÏßÄ ÏïäÏäµÎãàÎã§."; return; }
            msg.style.color = "var(--dim)"; msg.textContent = "Î≥ÄÍ≤Ω Ï§ë...";
            try {
                const r = await fetch(API, { method: "POST", body: JSON.stringify({ action: "changePw", userId: USER, currentPw: cur, newPw: nw }) });
                const d = await r.json();
                if (d.ok) {
                    msg.style.color = "var(--success)"; msg.textContent = "‚úÖ ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§!";
                    setTimeout(() => document.getElementById("pw-modal").style.display = "none", 1500);
                } else {
                    const errMap = { wrong_current_pw: "ÌòÑÏû¨ ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§.", weak_new_pw: "ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏Îäî 4Ïûê Ïù¥ÏÉÅÏù¥Ïñ¥Ïïº Ìï©ÎãàÎã§.", user_not_found: "Í≥ÑÏ†ïÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§." };
                    msg.style.color = "var(--danger)"; msg.textContent = errMap[d.error] || "Ïò§Î•ò: " + d.error;
                }
            } catch (e) { msg.style.color = "var(--warning)"; msg.textContent = "ÌÜµÏã† Ïò§Î•ò: " + e.message; }
        };

        /* ===== window.onload ===== */
        window.onload = function () {
            try { const saved = localStorage.getItem("WS_ID"); if (saved) { document.getElementById("loginId").value = saved; document.getElementById("loginId").closest('.login-field').style.opacity = '0.7'; document.getElementById("save-id-label").textContent = "Ï†ÄÏû•Îê® ‚úì"; document.getElementById("save-id-btn").textContent = "Ï†ÄÏû• Ìï¥Ï†ú"; document.getElementById("save-id-btn").style.color = "var(--accent)"; document.getElementById("save-id-btn").style.borderColor = "rgba(56,189,248,.3)"; document.getElementById("loginPw").focus(); } } catch (e) { }
            try {
                const s = sessionStorage.getItem("WS"), tk = sessionStorage.getItem("WTK");
                const role = sessionStorage.getItem("WR") || "C", region = sessionStorage.getItem("WRG") || "", site = sessionStorage.getItem("WST") || "";
                if (s) { USER = s; TK = tk; USER_ROLE = role; USER_REGION = region; USER_SITE = site; document.getElementById("login-overlay").style.display = "none"; applyRoleUI(); init(); setTimeout(() => initSecurity(s), 500); }
            } catch (e) { }
        };

        window.toggleSaveId = function () { try { const saved = localStorage.getItem("WS_ID"), btn = document.getElementById("save-id-btn"), lbl = document.getElementById("save-id-label"), idInput = document.getElementById("loginId"); if (saved) { localStorage.removeItem("WS_ID"); idInput.value = ""; idInput.closest('.login-field').style.opacity = '1'; idInput.disabled = false; lbl.textContent = ""; btn.textContent = "ÏïÑÏù¥Îîî Ï†ÄÏû•"; btn.style.color = "var(--muted)"; btn.style.borderColor = "var(--border)"; idInput.focus(); } else { const id = idInput.value.trim(); if (!id) { idInput.focus(); return; } localStorage.setItem("WS_ID", id); lbl.textContent = "Ï†ÄÏû•Îê® ‚úì"; btn.textContent = "Ï†ÄÏû• Ìï¥Ï†ú"; btn.style.color = "var(--accent)"; btn.style.borderColor = "rgba(56,189,248,.3)"; idInput.closest('.login-field').style.opacity = '0.7'; document.getElementById("loginPw").focus(); } } catch (e) { const lbl = document.getElementById("save-id-label"); if (lbl) lbl.textContent = "‚ö†Ô∏è Ï†ÄÏû• Î∂àÍ∞Ä"; setTimeout(function () { if (lbl) lbl.textContent = ""; }, 2000); } };

        /* ===== Î≥¥Ïïà Î™®Îìà (Í∏∞Ï°¥ Í∑∏ÎåÄÎ°ú) ===== */
        function initSecurity(userId) { function buildWatermark(uid) { const cvs = document.createElement('canvas'); cvs.width = 340; cvs.height = 160; const ctx = cvs.getContext('2d'); ctx.clearRect(0, 0, cvs.width, cvs.height); ctx.save(); ctx.translate(cvs.width / 2, cvs.height / 2); ctx.rotate(-Math.PI / 7); ctx.globalAlpha = 0.055; ctx.fillStyle = '#ffffff'; ctx.font = '700 15px Inter, sans-serif'; ctx.textAlign = 'center'; ctx.fillText('Samsung Welstory', 0, -18); ctx.font = '600 13px Inter, sans-serif'; ctx.fillText(uid + '@samsung.com', 0, 4); ctx.font = '500 11px Inter, sans-serif'; ctx.fillText(new Date().toLocaleDateString('ko-KR'), 0, 22); ctx.restore(); return cvs.toDataURL('image/png'); } const wmDiv = document.createElement('div'); wmDiv.id = 'wm-overlay'; wmDiv.style.cssText = `position:fixed;inset:0;z-index:99998;pointer-events:none;user-select:none;background-image:url(${buildWatermark(userId)});background-repeat:repeat;background-size:340px 160px;opacity:1;`; document.body.appendChild(wmDiv); const blurShield = document.createElement('div'); blurShield.id = 'blur-shield'; blurShield.style.cssText = `display:none;position:fixed;inset:0;z-index:99997;background:rgba(10,15,30,0.97);backdrop-filter:blur(20px);justify-content:center;align-items:center;flex-direction:column;gap:12px;pointer-events:all;`; blurShield.innerHTML = `<div style="font-size:48px;">üîí</div><div style="color:#f1f5f9;font-size:18px;font-weight:900;letter-spacing:-.5px">ÌôîÎ©¥ Î≥¥Ìò∏ Ï§ë</div><div style="color:#64748b;font-size:13px;text-align:center;line-height:1.6">ÌôîÎ©¥ Í≥µÏú† ÎòêÎäî Ï∫°Ï≤ò Í∞êÏßÄÎê®<br/>Ïù¥ Ï∞ΩÏùÑ Îã§Ïãú ÌÅ¥Î¶≠ÌïòÎ©¥ Ìï¥Ï†úÎê©ÎãàÎã§</div>`; document.body.appendChild(blurShield); function showShield() { if (!secReady) return; blurShield.style.display = 'flex'; } function hideShield() { blurShield.style.display = 'none'; } blurShield.addEventListener('click', hideShield); var secReady = false; setTimeout(function () { secReady = true; }, 5000); document.addEventListener('visibilitychange', () => { if (document.hidden) showShield(); else setTimeout(hideShield, 1200); }); if (navigator.mediaDevices && navigator.mediaDevices.getDisplayMedia) { const origGDM = navigator.mediaDevices.getDisplayMedia.bind(navigator.mediaDevices); navigator.mediaDevices.getDisplayMedia = async function (...args) { showShield(); const stream = await origGDM(...args); stream.getTracks().forEach(t => t.addEventListener('ended', hideShield)); return stream; }; } document.addEventListener("keydown", e => { const k = e.key.toLowerCase(); if (e.key === 'PrintScreen') { e.preventDefault(); showShield(); setTimeout(hideShield, 2000); return; } if (e.key === 'F12') { e.preventDefault(); return; } if (e.ctrlKey || e.metaKey) { const blocked = ['c', 'a', 'u', 's', 'p', 'x', 'f', 'g', 'e', 'h', 'r', 'l', 'd', 'n', 't', 'w', 'j']; if (blocked.includes(k)) { e.preventDefault(); return; } if (e.shiftKey && ['i', 'j', 'c', 'k', 'm', 'p', 'e'].includes(k)) { e.preventDefault(); return; } } }, true); document.addEventListener("contextmenu", e => e.preventDefault(), true); document.addEventListener("dragstart", e => e.preventDefault(), true); document.addEventListener("selectstart", e => { if (!['INPUT', 'TEXTAREA', 'SELECT'].includes(e.target.tagName)) e.preventDefault(); }, true); const noSelectStyle = document.createElement('style'); noSelectStyle.textContent = `body,.card,.tbl-wrap,.stats-row,.staff-panel,header,main{-webkit-user-select:none!important;-moz-user-select:none!important;user-select:none!important;}input,textarea,select{-webkit-user-select:text!important;user-select:text!important;}`; document.head.appendChild(noSelectStyle); let devToolsOpen = false; setInterval(() => { const threshold = 160; if (window.outerWidth - window.innerWidth > threshold || window.outerHeight - window.innerHeight > threshold) { if (!devToolsOpen) { devToolsOpen = true; showShield(); blurShield.innerHTML = `<div style="font-size:48px;">‚ö†Ô∏è</div><div style="color:#f87171;font-size:18px;font-weight:900">Í∞úÎ∞úÏûê ÎèÑÍµ¨ Í∞êÏßÄ</div><div style="color:#64748b;font-size:13px;text-align:center;line-height:1.6">Î≥¥Ïïà Ï†ïÏ±ÖÏóê ÏùòÌï¥ Ï†ëÍ∑ºÏù¥ Ï†úÌïúÎê©ÎãàÎã§<br/><span id="dev-countdown" style="color:#fbbf24;font-weight:700">5Ï¥à ÌõÑ Î°úÍ∑∏ÏïÑÏõÉ...</span></div>`; let countdown = 5; const timer = setInterval(() => { countdown--; const el = document.getElementById('dev-countdown'); if (el) el.textContent = `${countdown}Ï¥à ÌõÑ Î°úÍ∑∏ÏïÑÏõÉ...`; if (countdown <= 0) { clearInterval(timer); sessionStorage.clear(); location.reload(); } }, 1000); } } else { devToolsOpen = false; } }, 1000); console.log('%cüîê Î≥¥Ïïà ÏãúÏä§ÌÖú ÌôúÏÑ±ÌôîÎê®', 'color:#f87171;font-size:16px;font-weight:bold'); }
    </script>
</body>

</html>